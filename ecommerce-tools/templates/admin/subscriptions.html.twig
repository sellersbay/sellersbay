{% extends 'base.html.twig' %}

{% block title %}Subscription Plans - Admin - RoboSEO{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .admin-nav .nav-link {
            color: #4e73df;
            padding: 1rem;
            border-radius: 0.35rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        
        .admin-nav .nav-link:hover {
            background-color: #eaecf4;
        }
        
        .admin-nav .nav-link.active {
            background-color: #4e73df;
            color: white;
        }
        
        .admin-nav .nav-link i {
            margin-right: 0.5rem;
        }
        
        .stats-card {
            border-left: 4px solid #4e73df;
            transition: transform 0.2s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card.plans { border-left-color: #1cc88a; }
        .stats-card.subscribers { border-left-color: #f6c23e; }
        .stats-card.mrr { border-left-color: #36b9cc; }
        
        .subscription-plan-card {
            border: 1px solid #e3e6f0;
            border-radius: 0.35rem;
            transition: all 0.2s;
            margin-bottom: 1.5rem;
        }
        
        .subscription-plan-card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .subscription-plan-card.featured {
            border: 2px solid #1cc88a;
            position: relative;
        }
        
        .subscription-plan-card.featured::before {
            content: 'Recommended';
            position: absolute;
            top: -12px;
            right: 10px;
            background-color: #1cc88a;
            color: white;
            padding: 2px 10px;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .edit-plan-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        
        .subscription-plan-card:hover .edit-plan-btn {
            opacity: 1;
        }
        
        .plan-feature {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        
        .plan-feature i {
            color: #1cc88a;
            margin-right: 0.5rem;
            font-size: 0.9rem;
        }
        
        .promo-badge {
            background-color: #e74a3b;
            color: white;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .subscriber-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e3e6f0;
        }
        
        .subscriber-item:last-child {
            border-bottom: none;
        }
        
        .subscriber-name {
            font-weight: 600;
        }
        
        .subscriber-since {
            font-size: 0.8rem;
            color: #858796;
        }
        
        .subscription-status {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
        }
        
        .subscription-status.active {
            background-color: rgba(28, 200, 138, 0.1);
            color: #1cc88a;
        }
        
        .subscription-status.past-due {
            background-color: rgba(246, 194, 62, 0.1);
            color: #f6c23e;
        }
        
        .subscription-status.canceled {
            background-color: rgba(231, 74, 59, 0.1);
            color: #e74a3b;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">Subscription Plans</h1>
            <p class="text-muted">Manage subscription plans, pricing, and monitor subscriber activity.</p>
        </div>
    </div>

    <div class="row">
        <!-- Admin Navigation Sidebar -->
        <div class="col-xl-3 col-lg-4 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Admin Navigation</h6>
                </div>
                <div class="card-body">
                    <div class="admin-nav">
                        <a href="{{ path('app_admin_dashboard') }}" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                        <a href="{{ path('app_admin_users') }}" class="nav-link">
                            <i class="fas fa-users"></i> User Management
                        </a>
                        <a href="{{ path('app_admin_products') }}" class="nav-link">
                            <i class="fas fa-box"></i> Product Management
                        </a>
                        <a href="{{ path('app_admin_credits') }}" class="nav-link">
                            <i class="fas fa-coins"></i> Credits Management
                        </a>
                        <a href="{{ path('app_admin_subscriptions') }}" class="nav-link active">
                            <i class="fas fa-receipt"></i> Subscription Plans
                        </a>
                        <a href="{{ path('app_admin_statistics') }}" class="nav-link">
                            <i class="fas fa-chart-bar"></i> System Statistics
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createPlanModal">
                            <i class="fas fa-plus"></i> Create New Plan
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#planPromotionModal">
                            <i class="fas fa-tags"></i> Create Promotion
                        </button>
                        <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#planSettingsModal">
                            <i class="fas fa-cog"></i> Subscription Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-xl-9 col-lg-8">
            <!-- Stats Cards Row -->
            <div class="row mb-4">
                <!-- Subscribers Card -->
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card h-100 shadow stats-card subscribers">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Subscribers</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">58</div>
                                    <div class="text-xs text-success">
                                        <i class="fas fa-arrow-up me-1"></i>18% from last month
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-users fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Plans Card -->
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card h-100 shadow stats-card plans">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Plans</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">3</div>
                                    <div class="text-xs text-muted">
                                        <i class="fas fa-check-circle me-1"></i>All plans operational
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Recurring Revenue Card -->
                <div class="col-xl-4 col-md-6 mb-4">
                    <div class="card h-100 shadow stats-card mrr">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Monthly Revenue</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">$1,247.00</div>
                                    <div class="text-xs text-success">
                                        <i class="fas fa-arrow-up me-1"></i>12.5% from last month
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscription Plans (Monthly) -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Monthly Subscription Plans</h6>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createPlanModal">
                        <i class="fas fa-plus"></i> New Plan
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        {# The three static plan cards have been removed. Only the dynamic loop remains below. #}
                        {% for plan in subscriptionPlans|default([]) %}
                            <div class="col-lg-4 mb-4">
                                <div class="card h-100 subscription-plan-card {% if plan.featured %}featured{% endif %}">
                                    <button class="btn btn-sm btn-link edit-plan-btn" data-bs-toggle="modal" data-bs-target="#editPlanModal" data-plan-id="{{ plan.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <div class="card-body text-center">
                                        <h3 class="mb-4">{{ plan.name }}</h3>
                                        <div class="pricing mb-4">
                                            {% if plan.discount is not null and plan.discount > 0 %}
                                                <div class="promo-badge">SALE -{{ plan.discount }}%</div>
                                                <div class="text-muted text-decoration-line-through">${{ plan.original_price|default(plan.price)|number_format(2) }}</div>
                                            {% endif %}
                                            <div class="h1 mb-0">${{ plan.price|number_format(2) }}</div>
                                            <div class="text-muted">per month</div>
                                        </div>
                                        <div class="features-badge mb-4">
                                            <span class="badge bg-primary p-2">
                                                <i class="fas fa-coins"></i>
                                                {{ plan.credits }} Credits/month
                                            </span>
                                        </div>
                                        {% if plan.description is defined and plan.description is not empty %}
                                        <div class="plan-description mb-4 text-start">
                                            <small class="text-muted">{{ plan.description }}</small>
                                        </div>
                                        {% endif %}
                                        <div class="features-list text-start mb-4">
                                            <div class="plan-feature">
                                                <i class="fas fa-check"></i>
                                                <span>Access to AI content generation</span>
                                            </div>
                                            <div class="plan-feature">
                                                <i class="fas fa-check"></i>
                                                <span>Product descriptions</span>
                                            </div>
                                            <div class="plan-feature">
                                                <i class="fas fa-check"></i>
                                                <span>Meta descriptions</span>
                                            </div>
                                            <div class="plan-feature {% if not plan.features.seo_keywords|default(false) %}text-muted{% endif %}">
                                                <i class="fas {% if plan.features.seo_keywords|default(false) %}fa-check{% else %}fa-times{% endif %}"></i>
                                                <span>SEO keywords</span>
                                            </div>
                                            <div class="plan-feature {% if not plan.features.premium_ai|default(false) %}text-muted{% endif %}">
                                                <i class="fas {% if plan.features.premium_ai|default(false) %}fa-check{% else %}fa-times{% endif %}"></i>
                                                <span>Premium AI model (GPT-4)</span>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">
                                                <i class="fas fa-user me-1"></i> {{ plan.subscribers|default(0) }} subscribers
                                            </span>
                                            <span class="text-muted">
                                                ${{ plan.credits > 0 ? (plan.price / plan.credits)|number_format(2) : '0.00' }} / credit
                                            </span>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent d-flex justify-content-between">
                                        <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#planStatsModal" data-plan-id="{{ plan.id }}">
                                            <i class="fas fa-chart-bar"></i> Stats
                                        </button>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="{{ plan.id }}PlanActive" {% if plan.active %}checked{% endif %}>
                                            <label class="form-check-label" for="{{ plan.id }}PlanActive">
                                                <span class="status-text">Active</span>
                                                <span class="badge {% if plan.active %}bg-success{% else %}bg-secondary{% endif %} ms-1 status-badge">
                                                    {{ plan.active ? 'On' : 'Off' }}
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="col-12">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i> No subscription plans found. Click the "New Plan" button to create one.
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- One-Time Credit Packages (Add-Ons) -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">One-Time Credit Packages</h6>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createPackageModal">
                        <i class="fas fa-plus"></i> New Package
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> These are one-time purchase credit packages. Users with active subscriptions can purchase these for additional credits.
                    </div>
                    <div class="row">
                        {% for package in packageAddOns|default([]) %}
                            <div class="col-lg-4 mb-4">
                                <div class="card h-100 subscription-plan-card {% if package.featured %}featured{% endif %}">
                                    <button class="btn btn-sm btn-link edit-plan-btn" data-bs-toggle="modal" data-bs-target="#editPackageModal" data-package-id="{{ package.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <div class="card-body text-center">
                                        <h3 class="mb-4">{{ package.name }}</h3>
                                        <div class="pricing mb-4">
                                            {% if package.discount is not null and package.discount > 0 %}
                                                <div class="promo-badge">SALE -{{ package.discount }}%</div>
                                                <div class="text-muted text-decoration-line-through">${{ package.original_price_standard|default(package.price_standard)|number_format(2) }}</div>
                                            {% endif %}
                                            <div class="h1 mb-0">${{ package.price_standard|number_format(2) }}</div>
                                            <div class="text-muted">standard price</div>
                                            <div class="h5 mt-2">${{ package.price_premium|number_format(2) }}</div>
                                            <div class="text-muted">premium price</div>
                                        </div>
                                        <div class="features-badge mb-4">
                                            <span class="badge bg-warning p-2">
                                                <i class="fas fa-coins"></i>
                                                {{ package.credits }} Credits
                                            </span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-4">
                                            <span class="text-muted">
                                                <i class="fas fa-shopping-cart me-1"></i> {{ package.sales|default(0) }} purchases
                                            </span>
                                            <span class="text-muted">
                                                Standard: ${{ package.per_credit_price_standard|number_format(2) }}/credit
                                            </span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted">
                                                Premium: ${{ package.per_credit_price_premium|number_format(2) }}/credit
                                            </span>
                                            <span class="badge {% if package.active %}bg-success{% else %}bg-secondary{% endif %}">
                                                {{ package.active ? 'Active' : 'Inactive' }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent d-flex justify-content-between">
                                        <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#packageStatsModal" data-package-id="{{ package.id }}">
                                            <i class="fas fa-chart-bar"></i> Stats
                                        </button>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="package{{ package.id }}Active" {% if package.active %}checked{% endif %}>
                                            <label class="form-check-label" for="package{{ package.id }}Active">
                                                <span class="status-text">Active</span>
                                                <span class="badge {% if package.active %}bg-success{% else %}bg-secondary{% endif %} ms-1 status-badge">
                                                    {{ package.active ? 'On' : 'Off' }}
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="col-12">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i> No credit packages found. Click the "New Package" button to create one.
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Recent Subscribers -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Subscribers</h6>
                    <a href="{{ path('app_admin_users') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-users"></i> View All Users
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Plan</th>
                                            <th>Status</th>
                                            <th>Subscribed</th>
                                            <th>Next Billing</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <a href="#">John Smith</a>
                                                <div class="small text-muted">john.smith@example.com</div>
                                            </td>
                                            <td>Pro Plan</td>
                                            <td><span class="subscription-status active">Active</span></td>
                                            <td>2023-12-10</td>
                                            <td>2024-01-10</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editSubscriptionModal" data-user-id="1" data-user-name="John Smith" data-user-email="john.smith@example.com">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <a href="#">Sarah Johnson</a>
                                                <div class="small text-muted">sarah.j@example.com</div>
                                            </td>
                                            <td>Basic Plan</td>
                                            <td><span class="subscription-status past-due">Past Due</span></td>
                                            <td>2023-12-05</td>
                                            <td>2024-01-05</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editSubscriptionModal" data-user-id="2" data-user-name="Sarah Johnson" data-user-email="sarah.j@example.com">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <a href="#">Robert Brown</a>
                                                <div class="small text-muted">r.brown@example.com</div>
                                            </td>
                                            <td>Business Plan</td>
                                            <td><span class="subscription-status active">Active</span></td>
                                            <td>2023-12-01</td>
                                            <td>2024-01-01</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editSubscriptionModal" data-user-id="3" data-user-name="Robert Brown" data-user-email="r.brown@example.com">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <a href="#">Emma Wilson</a>
                                                <div class="small text-muted">emma.w@example.com</div>
                                            </td>
                                            <td>Pro Plan</td>
                                            <td><span class="subscription-status active">Active</span></td>
                                            <td>2023-11-28</td>
                                            <td>2023-12-28</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editSubscriptionModal" data-user-id="4" data-user-name="Emma Wilson" data-user-email="emma.w@example.com">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <a href="#">Michael Davis</a>
                                                <div class="small text-muted">m.davis@example.com</div>
                                            </td>
                                            <td>Basic Plan</td>
                                            <td><span class="subscription-status canceled">Canceled</span></td>
                                            <td>2023-11-15</td>
                                            <td>N/A</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editSubscriptionModal" data-user-id="5" data-user-name="Michael Davis" data-user-email="m.davis@example.com">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" disabled>
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">Subscription Overview</h6>
                                    <div class="mb-4">
                                        <div class="small fw-bold mb-1">Plan Distribution</div>
                                        <div class="progress mb-2" style="height: 10px;">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: 55%;" aria-valuenow="55" aria-valuemin="0" aria-valuemax="100"></div>
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100"></div>
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: 12%;" aria-valuenow="12" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between small text-muted">
                                            <div>
                                                <i class="fas fa-circle text-primary"></i> Basic (55%)
                                            </div>
                                            <div>
                                                <i class="fas fa-circle text-success"></i> Pro (33%)
                                            </div>
                                            <div>
                                                <i class="fas fa-circle text-warning"></i> Business (12%)
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <div class="small fw-bold mb-1">Subscription Status</div>
                                        <div class="progress mb-2" style="height: 10px;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: 86%;" aria-valuenow="86" aria-valuemin="0" aria-valuemax="100"></div>
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: 9%;" aria-valuenow="9" aria-valuemin="0" aria-valuemax="100"></div>
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: 5%;" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="d-flex justify-content-between small text-muted">
                                            <div>
                                                <i class="fas fa-circle text-success"></i> Active (86%)
                                            </div>
                                            <div>
                                                <i class="fas fa-circle text-warning"></i> Past Due (9%)
                                            </div>
                                            <div>
                                                <i class="fas fa-circle text-danger"></i> Canceled (5%)
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="small fw-bold mb-1">Retention Rate</div>
                                        <div class="d-flex align-items-center">
                                            <div class="display-4 me-3">93%</div>
                                            <div class="text-success">
                                                <i class="fas fa-arrow-up me-1"></i>
                                                <span class="text-success">2.5%</span>
                                                <div class="small text-muted">from last month</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">Subscription Actions</h6>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#bulkEmailModal">
                                            <i class="fas fa-envelope"></i> Send Subscriber Email
                                        </button>
                                        <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#exportSubscribersModal">
                                            <i class="fas fa-file-export"></i> Export Subscriber Data
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#renewalReminderModal">
                                            <i class="fas fa-bell"></i> Configure Renewal Reminders
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Create Plan Modal -->
<div class="modal fade" id="createPlanModal" tabindex="-1" aria-labelledby="createPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPlanModalLabel">Create New Subscription Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPlanForm" action="{{ path('app_admin_create_subscription_plan') }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('create_plan') }}">
                    <div class="mb-3">
                        <label for="planName" class="form-label">Plan Name</label>
                        <input type="text" class="form-control" id="planName" name="planName" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="planPrice" class="form-label">Monthly Price (USD)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="planPrice" name="planPrice" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="planCredits" class="form-label">Monthly Credits</label>
                            <input type="number" class="form-control" id="planCredits" name="planCredits" min="1" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="planDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="planDescription" name="planDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Features</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featureProductDesc" name="featureProductDesc" checked>
                            <label class="form-check-label" for="featureProductDesc">
                                Product Descriptions
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featureMetaDesc" name="featureMetaDesc" checked>
                            <label class="form-check-label" for="featureMetaDesc">
                                Meta Descriptions
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featureImageAlt" name="featureImageAlt" checked>
                            <label class="form-check-label" for="featureImageAlt">
                                Image Alt Text
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featureSeoKeywords" name="featureSeoKeywords">
                            <label class="form-check-label" for="featureSeoKeywords">
                                SEO Keywords
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featurePremiumAI" name="featurePremiumAI">
                            <label class="form-check-label" for="featurePremiumAI">
                                Premium AI Model (GPT-4)
                            </label>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="planTerm" class="form-label">Billing Term</label>
                            <select class="form-select" id="planTerm" name="planTerm">
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="planDiscount" class="form-label">Discount (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="planDiscount" name="planDiscount" min="0" max="100" value="0">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="planStripeID" class="form-label">Stripe Plan ID</label>
                            <input type="text" class="form-control" id="planStripeID" name="planStripeID">
                        </div>
                        <div class="col-md-6">
                            <label for="planDisplayOrder" class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="planDisplayOrder" name="planDisplayOrder" min="1" value="1">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="planIsFeatured" name="planIsFeatured">
                        <label class="form-check-label" for="planIsFeatured">
                            Feature this plan (Recommended)
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="planIsActive" name="planIsActive" checked>
                        <label class="form-check-label" for="planIsActive">
                            Plan is active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewPlanBtn" onclick="document.getElementById('createPlanForm').submit()">Create Plan</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Package Modal -->
<div class="modal fade" id="createPackageModal" tabindex="-1" aria-labelledby="createPackageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPackageModalLabel">Create New Credit Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPackageForm" action="{{ path('app_admin_create_package_addon') }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('create_package') }}">
                    <div class="mb-3">
                        <label for="packageName" class="form-label">Package Name</label>
                        <input type="text" class="form-control" id="packageName" name="packageName" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="packagePriceStandard" class="form-label">Standard Price (USD)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="packagePriceStandard" name="packagePriceStandard" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="packagePricePremium" class="form-label">Premium Price (USD)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="packagePricePremium" name="packagePricePremium" min="0.01" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="packageCredits" class="form-label">Credits</label>
                        <input type="number" class="form-control" id="packageCredits" name="packageCredits" min="1" required>
                        <small class="form-text text-muted">Number of credits the user will receive</small>
                    </div>
                    <div class="mb-3">
                        <label for="packageDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="packageDescription" name="packageDescription" rows="2"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="packageDiscount" class="form-label">Discount (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="packageDiscount" name="packageDiscount" min="0" max="100" value="0">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="packageDisplayOrder" class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="packageDisplayOrder" name="packageDisplayOrder" min="1" value="1">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="packageStripeID" class="form-label">Stripe Product ID</label>
                        <input type="text" class="form-control" id="packageStripeID" name="packageStripeID">
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="packageIsFeatured" name="packageIsFeatured">
                        <label class="form-check-label" for="packageIsFeatured">
                            Feature this package (Recommended)
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="packageIsActive" name="packageIsActive" checked>
                        <label class="form-check-label" for="packageIsActive">
                            Package is active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveNewPackageBtn" onclick="document.getElementById('createPackageForm').submit()">Create Package</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Package Modal -->
<div class="modal fade" id="editPackageModal" tabindex="-1" aria-labelledby="editPackageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPackageModalLabel">Edit Credit Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPackageForm" action="{{ path('app_admin_edit_package_addon', {'id': 'placeholder'}) }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('edit_package') }}">
                    <input type="hidden" id="editPackageId" name="id">
                    <div class="mb-3">
                        <label for="editPackageName" class="form-label">Package Name</label>
                        <input type="text" class="form-control" id="editPackageName" name="editPackageName" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPackagePriceStandard" class="form-label">Standard Price (USD)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editPackagePriceStandard" name="editPackagePriceStandard" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="editPackagePricePremium" class="form-label">Premium Price (USD)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editPackagePricePremium" name="editPackagePricePremium" min="0.01" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editPackageCredits" class="form-label">Credits</label>
                        <input type="number" class="form-control" id="editPackageCredits" name="editPackageCredits" min="1" required>
                        <small class="form-text text-muted">Number of credits the user will receive</small>
                    </div>
                    <div class="mb-3">
                        <label for="editPackageDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editPackageDescription" name="editPackageDescription" rows="2"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPackageDiscount" class="form-label">Discount (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editPackageDiscount" name="editPackageDiscount" min="0" max="100" value="0">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="editPackageDisplayOrder" class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="editPackageDisplayOrder" name="editPackageDisplayOrder" min="1" value="1">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="editPackageStripeID" class="form-label">Stripe Product ID</label>
                            <input type="text" class="form-control" id="editPackageStripeID" name="editPackageStripeID">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPackageStripePriceStandard" class="form-label">Stripe Price ID (Standard)</label>
                            <input type="text" class="form-control" id="editPackageStripePriceStandard" name="editPackageStripePriceStandard">
                        </div>
                        <div class="col-md-6">
                            <label for="editPackageStripePricePremium" class="form-label">Stripe Price ID (Premium)</label>
                            <input type="text" class="form-control" id="editPackageStripePricePremium" name="editPackageStripePricePremium">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editPackageIsFeatured" name="editPackageIsFeatured">
                        <label class="form-check-label" for="editPackageIsFeatured">
                            Feature this package (Recommended)
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editPackageIsActive" name="editPackageIsActive" checked>
                        <label class="form-check-label" for="editPackageIsActive">
                            Package is active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="deletePackageBtn" onclick="submitDeletePackageForm()">Delete Package</button>
                <button type="button" class="btn btn-primary" id="savePackageChangesBtn" onclick="document.getElementById('editPackageForm').submit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Package Stats Modal -->
<div class="modal fade" id="packageStatsModal" tabindex="-1" aria-labelledby="packageStatsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="packageStatsModalLabel">Package Statistics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="packageStatsTitle">Pro Package</h4>
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="small text-muted mb-2">Total Sales</h6>
                                <div class="h3 mb-0">78</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="small text-muted mb-2">Total Revenue</h6>
                                <div class="h3 mb-0">$7,722.00</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="small text-muted mb-2">Conversion Rate</h6>
                                <div class="h3 mb-0">8.4%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="small text-muted mb-2">Credits Issued</h6>
                                <div class="h3 mb-0">7,800</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8 mb-4">
                        <h6 class="small font-weight-bold text-uppercase mb-3">Sales Trend</h6>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="packageSalesChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <h6 class="small font-weight-bold text-uppercase mb-3">Recent Purchases</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>2023-12-10</td>
                                        <td>John S.</td>
                                    </tr>
                                    <tr>
                                        <td>2023-12-08</td>
                                        <td>Emma W.</td>
                                    </tr>
                                    <tr>
                                        <td>2023-12-05</td>
                                        <td>Robert B.</td>
                                    </tr>
                                    <tr>
                                        <td>2023-11-28</td>
                                        <td>James T.</td>
                                    </tr>
                                    <tr>
                                        <td>2023-11-27</td>
                                        <td>Lisa M.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Export Data</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Plan Modal -->
<div class="modal fade" id="editPlanModal" tabindex="-1" aria-labelledby="editPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPlanModalLabel">Edit Subscription Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPlanForm" action="{{ path('app_admin_edit_subscription_plan', {'id': 'placeholder'}) }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('edit_plan') }}">
                    <input type="hidden" id="editPlanId" name="id">
                    <div class="mb-3">
                        <label for="editPlanName" class="form-label">Plan Name</label>
                        <input type="text" class="form-control" id="editPlanName" name="editPlanName" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPlanPrice" class="form-label">Monthly Price (USD)</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="editPlanPrice" name="editPlanPrice" min="0.01" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="editPlanCredits" class="form-label">Monthly Credits</label>
                            <input type="number" class="form-control" id="editPlanCredits" name="editPlanCredits" min="1" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editPlanDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editPlanDescription" name="editPlanDescription" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Features</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editFeatureProductDesc" name="editFeatureProductDesc" checked>
                            <label class="form-check-label" for="editFeatureProductDesc">
                                Product Descriptions
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editFeatureMetaDesc" name="editFeatureMetaDesc" checked>
                            <label class="form-check-label" for="editFeatureMetaDesc">
                                Meta Descriptions
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editFeatureImageAlt" name="editFeatureImageAlt" checked>
                            <label class="form-check-label" for="editFeatureImageAlt">
                                Image Alt Text
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editFeatureSeoKeywords" name="editFeatureSeoKeywords">
                            <label class="form-check-label" for="editFeatureSeoKeywords">
                                SEO Keywords
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editFeaturePremiumAI" name="editFeaturePremiumAI">
                            <label class="form-check-label" for="editFeaturePremiumAI">
                                Premium AI Model (GPT-4)
                            </label>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPlanTerm" class="form-label">Billing Term</label>
                            <select class="form-select" id="editPlanTerm" name="editPlanTerm">
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editPlanDiscount" class="form-label">Discount (%)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editPlanDiscount" name="editPlanDiscount" min="0" max="100" value="0">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editPlanStripeID" class="form-label">Stripe Plan ID</label>
                            <input type="text" class="form-control" id="editPlanStripeID" name="editPlanStripeID">
                        </div>
                        <div class="col-md-6">
                            <label for="editPlanDisplayOrder" class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="editPlanDisplayOrder" name="editPlanDisplayOrder" min="1" value="1">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editPlanIsFeatured" name="editPlanIsFeatured">
                        <label class="form-check-label" for="editPlanIsFeatured">
                            Feature this plan (Recommended)
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editPlanIsActive" name="editPlanIsActive" checked>
                        <label class="form-check-label" for="editPlanIsActive">
                            Plan is active
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="deletePlanBtn" onclick="submitDeletePlanForm()">Delete Plan</button>
                <button type="button" class="btn btn-primary" id="savePlanChangesBtn" onclick="document.getElementById('editPlanForm').submit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Subscription Modal -->
<div class="modal fade" id="editSubscriptionModal" tabindex="-1" aria-labelledby="editSubscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSubscriptionModalLabel">Edit User Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSubscriptionForm" action="{{ path('app_admin_edit_user_subscription', {'id': 0}) }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('edit_subscription') }}">
                    <input type="hidden" name="userId" id="editSubscriptionUserId" value="">
                    <div class="mb-3">
                        <label class="form-label">User</label>
                        <div class="fw-bold">John Smith</div>
                        <div class="small text-muted">john.smith@example.com</div>
                    </div>
                    <div class="mb-3">
                        <label for="editSubscriptionPlan" class="form-label">Subscription Plan</label>
                        <select class="form-select" id="editSubscriptionPlan" name="editSubscriptionPlan">
                            <option value="basic">Basic Plan</option>
                            <option value="pro" selected>Pro Plan</option>
                            <option value="business">Business Plan</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSubscriptionStatus" class="form-label">Status</label>
                        <select class="form-select" id="editSubscriptionStatus" name="editSubscriptionStatus">
                            <option value="active" selected>Active</option>
                            <option value="pastdue">Past Due</option>
                            <option value="canceled">Canceled</option>
                            <option value="paused">Paused</option>
                        </select>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="editSubscriptionStartDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="editSubscriptionStartDate" name="editSubscriptionStartDate" value="2023-12-10">
                        </div>
                        <div class="col-md-6">
                            <label for="editSubscriptionNextBilling" class="form-label">Next Billing Date</label>
                            <input type="date" class="form-control" id="editSubscriptionNextBilling" name="editSubscriptionNextBilling" value="2024-01-10">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editSubscriptionCustomCredits" class="form-label">Custom Credits (Override)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editSubscriptionCustomCredits" name="editSubscriptionCustomCredits" placeholder="Leave blank for default">
                            <span class="input-group-text">credits</span>
                        </div>
                        <small class="form-text text-muted">Default for Pro Plan: 100 credits/month</small>
                    </div>
                    <div class="mb-3">
                        <label for="editSubscriptionNotes" class="form-label">Admin Notes</label>
                        <textarea class="form-control" id="editSubscriptionNotes" name="editSubscriptionNotes" rows="2"></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="editSubscriptionNotifyUser" name="editSubscriptionNotifyUser">
                        <label class="form-check-label" for="editSubscriptionNotifyUser">
                            Notify user about changes via email
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" id="cancelSubscriptionBtn" onclick="submitCancelSubscriptionForm()">Cancel Subscription</button>
                <button type="button" class="btn btn-primary" id="saveSubscriptionBtn" onclick="document.getElementById('editSubscriptionForm').submit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Plan Promotion Modal -->
<div class="modal fade" id="planPromotionModal" tabindex="-1" aria-labelledby="planPromotionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="planPromotionModalLabel">Create Plan Promotion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="planPromotionForm" action="{{ path('app_admin_create_plan_promotion') }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('create_plan_promotion') }}">
                    <div class="mb-3">
                        <label for="promotionName" class="form-label">Promotion Name</label>
                        <input type="text" class="form-control" id="promotionName" name="promotionName" required>
                    </div>
                    <div class="mb-3">
                        <label for="promotionType" class="form-label">Promotion Type</label>
                        <select class="form-select" id="promotionType" name="promotionType">
                            <option value="discount">Percentage Discount</option>
                            <option value="free_month">Free Month</option>
                            <option value="bonus_credits">Bonus Credits</option>
                        </select>
                    </div>
                    <div class="mb-3 promotion-discount">
                        <label for="discountPercentage" class="form-label">Discount Percentage</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="discountPercentage" name="discountPercentage" min="1" max="100" value="15" required>
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="mb-3 promotion-bonus-credits d-none">
                        <label for="bonusCredits" class="form-label">Bonus Credits</label>
                        <input type="number" class="form-control" id="bonusCredits" name="bonusCredits" min="1" value="20" required>
                    </div>
                    <div class="mb-3">
                        <label for="promotionDuration" class="form-label">Duration</label>
                        <select class="form-select" id="promotionDuration" name="promotionDuration">
                            <option value="first_month">First Month Only</option>
                            <option value="three_months">First 3 Months</option>
                            <option value="forever">Lifetime of Subscription</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="promotionPlans" class="form-label">Apply to Plans</label>
                        <select class="form-select" id="promotionPlans" name="promotionPlans[]" multiple>
                            <option value="basic">Basic Plan</option>
                            <option value="pro">Pro Plan</option>
                            <option value="business">Business Plan</option>
                        </select>
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple plans</small>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="promotionStartDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="promotionStartDate" name="promotionStartDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="promotionEndDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="promotionEndDate" name="promotionEndDate" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="promotionCode" class="form-label">Promo Code (Optional)</label>
                        <input type="text" class="form-control" id="promotionCode" name="promotionCode">
                        <small class="form-text text-muted">Leave blank to apply automatically</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePromotionBtn" onclick="document.getElementById('planPromotionForm').submit()">Create Promotion</button>
            </div>
        </div>
    </div>
</div>

<!-- Plan Settings Modal -->
<div class="modal fade" id="planSettingsModal" tabindex="-1" aria-labelledby="planSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="planSettingsModalLabel">Subscription Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="planSettingsForm" action="{{ path('app_admin_update_subscription_settings') }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('update_subscription_settings') }}">
                    <div class="mb-3">
                        <label class="form-label">Billing Options</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="optionMonthly" name="optionMonthly" checked>
                            <label class="form-check-label" for="optionMonthly">
                                Allow Monthly Billing
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="optionYearly" name="optionYearly" checked>
                            <label class="form-check-label" for="optionYearly">
                                Allow Yearly Billing
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="optionYearlyDiscount" name="optionYearlyDiscount" checked>
                            <label class="form-check-label" for="optionYearlyDiscount">
                                Apply Discount for Yearly Billing
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="yearlyDiscountPercent" class="form-label">Yearly Discount Percentage</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="yearlyDiscountPercent" name="yearlyDiscountPercent" min="0" max="100" value="20">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="freeTrialDays" class="form-label">Free Trial Period</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="freeTrialDays" name="freeTrialDays" min="0" value="14">
                            <span class="input-group-text">days</span>
                        </div>
                        <small class="form-text text-muted">0 to disable free trials</small>
                    </div>
                    <div class="mb-3">
                        <label for="gracePeriodDays" class="form-label">Payment Grace Period</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="gracePeriodDays" name="gracePeriodDays" min="0" value="3">
                            <span class="input-group-text">days</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="paymentFailureAttempts" class="form-label">Payment Retry Attempts</label>
                        <input type="number" class="form-control" id="paymentFailureAttempts" name="paymentFailureAttempts" min="1" value="3">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Options</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="paymentCredit" name="paymentCredit" checked>
                            <label class="form-check-label" for="paymentCredit">
                                Credit/Debit Cards
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="paymentPayPal" name="paymentPayPal">
                            <label class="form-check-label" for="paymentPayPal">
                                PayPal
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="paymentBank" name="paymentBank">
                            <label class="form-check-label" for="paymentBank">
                                Bank Transfer
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email Notifications</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailWelcome" name="emailWelcome" checked>
                            <label class="form-check-label" for="emailWelcome">
                                New Subscription Welcome
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailRenewal" name="emailRenewal" checked>
                            <label class="form-check-label" for="emailRenewal">
                                Renewal Reminders
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailPaymentFailed" name="emailPaymentFailed" checked>
                            <label class="form-check-label" for="emailPaymentFailed">
                                Payment Failure
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailCancellation" name="emailCancellation" checked>
                            <label class="form-check-label" for="emailCancellation">
                                Subscription Cancellation
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn" onclick="document.getElementById('planSettingsForm').submit()">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Plan Stats Modal -->
<div class="modal fade" id="planStatsModal" tabindex="-1" aria-labelledby="planStatsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="planStatsModalLabel">Plan Statistics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="planStatsTitle">Pro Plan</h4>
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="small text-muted mb-2">Subscribers</h6>
                                <div class="h3 mb-0">19</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="small text-muted mb-2">Monthly Revenue</h6>
                                <div class="h3 mb-0">$664.81</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="small text-muted mb-2">Avg. Retention</h6>
                                <div class="h3 mb-0">4.3</div>
                                <div class="small text-muted">months</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="small text-muted mb-2">Conversion Rate</h6>
                                <div class="h3 mb-0">23.5%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-8 mb-4">
                        <h6 class="small font-weight-bold text-uppercase mb-3">Subscription Growth</h6>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="planGrowthChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <h6 class="small font-weight-bold text-uppercase mb-3">Recent Subscribers</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>2023-12-10</td>
                                        <td>John S.</td>
                                    </tr>
                                    <tr>
                                        <td>2023-12-08</td>
                                        <td>Emma W.</td>
                                    </tr>
                                    <tr>
                                        <td>2023-12-05</td>
                                        <td>Robert B.</td>
                                    </tr>
                                    <tr>
                                        <td>2023-11-28</td>
                                        <td>James T.</td>
                                    </tr>
                                    <tr>
                                        <td>2023-11-27</td>
                                        <td>Lisa M.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Export Data</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Email Modal -->
<div class="modal fade" id="bulkEmailModal" tabindex="-1" aria-labelledby="bulkEmailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkEmailModalLabel">Send Bulk Email to Subscribers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulkEmailForm" action="{{ path('app_admin_send_bulk_email') }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('send_bulk_email') }}">
                    <div class="mb-3">
                        <label for="emailRecipients" class="form-label">Recipients</label>
                        <select class="form-select" id="emailRecipients" name="emailRecipients">
                            <option value="all">All Subscribers</option>
                            <option value="basic">Basic Plan Subscribers</option>
                            <option value="pro">Pro Plan Subscribers</option>
                            <option value="business">Business Plan Subscribers</option>
                            <option value="active">Active Subscriptions Only</option>
                            <option value="expiring">Subscriptions Expiring Soon</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">Email Subject</label>
                        <input type="text" class="form-control" id="emailSubject" name="emailSubject" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailBody" class="form-label">Email Content</label>
                        <textarea class="form-control" id="emailBody" name="emailBody" rows="8" required></textarea>
                        <div class="form-text">
                            Available variables: {name}, {email}, {plan}, {credits}, {expiry_date}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="emailTestAddress" class="form-label">Send Test To (Optional)</label>
                        <input type="email" class="form-control" id="emailTestAddress" name="emailTestAddress" placeholder="your@email.com">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailSchedule" name="emailSchedule">
                            <label class="form-check-label" for="emailSchedule">
                                Schedule for later
                            </label>
                        </div>
                    </div>
                    <div class="mb-3 email-schedule-options d-none">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="emailScheduleDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="emailScheduleDate" name="emailScheduleDate">
                            </div>
                            <div class="col-md-6">
                                <label for="emailScheduleTime" class="form-label">Time</label>
                                <input type="time" class="form-control" id="emailScheduleTime" name="emailScheduleTime">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendTestEmailBtn" onclick="submitTestEmailForm()">Send Test</button>
                <button type="button" class="btn btn-success" id="sendBulkEmailBtn" onclick="document.getElementById('bulkEmailForm').submit()">Send Email</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle toggle switches for subscription plans
    const planToggleSwitches = document.querySelectorAll('.form-check-input[id$="PlanActive"]');
    planToggleSwitches.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const planId = this.id.replace('PlanActive', '');
            const isActive = this.checked;
            
            console.log(`Toggle switch changed for plan ${planId} - Active: ${isActive}`);
            
            // Show a loading indicator
            const parentCard = this.closest('.subscription-plan-card');
            const originalHTML = parentCard.innerHTML;
            parentCard.style.opacity = '0.6';
            
            // Extract all plan data from the card to avoid missing required fields
            const planName = parentCard.querySelector('h3').textContent;
            const planPrice = parseFloat(parentCard.querySelector('.h1.mb-0').textContent.replace('$', ''));
            const planCredits = parseInt(parentCard.querySelector('.badge.bg-primary').textContent.match(/\d+/)[0]);
            
            console.log(`Plan data: Name=${planName}, Price=${planPrice}, Credits=${planCredits}`);
            
            // Create a comprehensive form data object with all required fields
            const formData = new FormData();
            formData.append('editPlanIsActive', isActive ? '1' : '0'); // Always use "1" or "0" values for consistency
            formData.append('_csrf_token', '{{ csrf_token('edit_plan') }}');
            formData.append('editPlanName', planName);
            formData.append('editPlanPrice', planPrice);
            formData.append('editPlanCredits', planCredits);
            formData.append('editPlanDescription', ''); // Default to empty if not found
            formData.append('editPlanTerm', 'monthly');
            formData.append('editPlanDiscount', '0');
            formData.append('editPlanDisplayOrder', '1');
            
            // Preserve featured status if we can determine it
            const isFeatured = parentCard.classList.contains('featured');
            formData.append('editPlanIsFeatured', isFeatured ? '1' : '0'); // Always use explicit values
            
            // Include feature values based on what's displayed in the card
            formData.append('editFeatureProductDesc', 'on');
            formData.append('editFeatureMetaDesc', 'on');
            formData.append('editFeatureImageAlt', 'on');
            
            // Check if SEO keywords feature is active
            if (parentCard.querySelector('.plan-feature:nth-child(4):not(.text-muted)')) {
                formData.append('editFeatureSeoKeywords', 'on');
            }
            
            // Check if Premium AI feature is active
            if (parentCard.querySelector('.plan-feature:nth-child(5):not(.text-muted)')) {
                formData.append('editFeaturePremiumAI', 'on');
            }
            
            // For debugging, log the form data
            console.log('Sending form data to server:');
            for (const pair of formData.entries()) {
                console.log(`${pair[0]}: ${pair[1]}`);
            }
            
            // Use the existing route to update the plan with cookies included for authentication
            fetch('{{ path('app_admin_edit_subscription_plan', {'id': 'PLAN_ID'}) }}'.replace('PLAN_ID', planId), {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server responded with an error');
                }
                
                // Create a toast or notification
                const toast = document.createElement('div');
                toast.className = 'position-fixed top-0 end-0 p-3 mt-5';
                toast.style.zIndex = '5000';
                toast.innerHTML = `
                    <div class="toast show bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-success text-white">
                            <strong class="me-auto">Success</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            Plan ${isActive ? 'activated' : 'deactivated'} successfully
                        </div>
                    </div>
                `;
                document.body.appendChild(toast);
                
                // Remove the toast after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
                
                // Restore the card's appearance
                parentCard.style.opacity = '1';
                
                // Update the visual status indicator
                const statusBadge = parentCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = `badge ${isActive ? 'bg-success' : 'bg-secondary'} ms-1 status-badge`;
                    statusBadge.textContent = isActive ? 'On' : 'Off';
                }
            })
            .catch(error => {
                console.error('Error updating plan:', error);
                
                // Show error message
                const toast = document.createElement('div');
                toast.className = 'position-fixed top-0 end-0 p-3 mt-5';
                toast.style.zIndex = '5000';
                toast.innerHTML = `
                    <div class="toast show bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-danger text-white">
                            <strong class="me-auto">Error</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            Failed to update plan status. Please try again.
                        </div>
                    </div>
                `;
                document.body.appendChild(toast);
                
                // Remove the toast after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
                
                // Revert the toggle to its previous state
                this.checked = !isActive;
                
                // Restore the card's appearance
                parentCard.style.opacity = '1';
                
                // Revert the visual status indicator
                const statusBadge = parentCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = `badge ${!isActive ? 'bg-success' : 'bg-secondary'} ms-1 status-badge`;
                    statusBadge.textContent = !isActive ? 'On' : 'Off';
                }
            });
        });
    });
    
    // Similar code for package add-on toggle switches
    const packageToggleSwitches = document.querySelectorAll('.form-check-input[id$="PackageActive"]');
    packageToggleSwitches.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const packageId = this.id.replace('PackageActive', '');
            const isActive = this.checked;
            
            console.log(`Toggle switch changed for package ${packageId} - Active: ${isActive}`);
            
            // Show a loading indicator
            const parentCard = this.closest('.subscription-plan-card');
            parentCard.style.opacity = '0.6';
            
            // Extract all package data from the card to avoid missing required fields
            const packageName = parentCard.querySelector('h3').textContent;
            const packagePriceStandard = parseFloat(parentCard.querySelector('.h1.mb-0').textContent.replace('$', ''));
            const packagePricePremium = parseFloat(parentCard.querySelector('.h5.mt-2').textContent.replace('$', ''));
            const packageCredits = parseInt(parentCard.querySelector('.badge.bg-warning').textContent.match(/\d+/)[0]);
            
            console.log(`Package data: Name=${packageName}, Price Standard=${packagePriceStandard}, Price Premium=${packagePricePremium}, Credits=${packageCredits}`);
            
            // Create a comprehensive form data object with all required fields
            const formData = new FormData();
            formData.append('editPackageIsActive', isActive ? '1' : '0'); // Always use "1" or "0" values for consistency
            formData.append('_csrf_token', '{{ csrf_token('edit_package') }}');
            formData.append('editPackageName', packageName);
            formData.append('editPackagePriceStandard', packagePriceStandard);
            formData.append('editPackagePricePremium', packagePricePremium);
            formData.append('editPackageCredits', packageCredits);
            formData.append('editPackageDescription', ''); // Default to empty if not found
            formData.append('editPackageDiscount', '0');
            formData.append('editPackageDisplayOrder', '1');
            
            // Preserve featured status if we can determine it
            const isFeatured = parentCard.classList.contains('featured');
            formData.append('editPackageIsFeatured', isFeatured ? '1' : '0'); // Always use explicit values
            
            // For debugging, log the form data
            console.log('Sending form data to server:');
            for (const pair of formData.entries()) {
                console.log(`${pair[0]}: ${pair[1]}`);
            }
            
            // Use the existing route to update the package with cookies included for authentication
            fetch('{{ path('app_admin_edit_package_addon', {'id': 'PACKAGE_ID'}) }}'.replace('PACKAGE_ID', packageId), {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server responded with an error');
                }
                
                // Create a toast or notification
                const toast = document.createElement('div');
                toast.className = 'position-fixed top-0 end-0 p-3 mt-5';
                toast.style.zIndex = '5000';
                toast.innerHTML = `
                    <div class="toast show bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-success text-white">
                            <strong class="me-auto">Success</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            Package ${isActive ? 'activated' : 'deactivated'} successfully
                        </div>
                    </div>
                `;
                document.body.appendChild(toast);
                
                // Remove the toast after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
                
                // Restore the card's appearance
                parentCard.style.opacity = '1';
                
                // Update the visual status indicator
                const statusBadge = parentCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = `badge ${isActive ? 'bg-success' : 'bg-secondary'} ms-1 status-badge`;
                    statusBadge.textContent = isActive ? 'On' : 'Off';
                }
            })
            .catch(error => {
                console.error('Error updating package:', error);
                
                // Show error message
                const toast = document.createElement('div');
                toast.className = 'position-fixed top-0 end-0 p-3 mt-5';
                toast.style.zIndex = '5000';
                toast.innerHTML = `
                    <div class="toast show bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-danger text-white">
                            <strong class="me-auto">Error</strong>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body">
                            Failed to update package status. Please try again.
                        </div>
                    </div>
                `;
                document.body.appendChild(toast);
                
                // Remove the toast after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
                
                // Revert the toggle to its previous state
                this.checked = !isActive;
                
                // Restore the card's appearance
                parentCard.style.opacity = '1';
                
                // Revert the visual status indicator
                const statusBadge = parentCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = `badge ${!isActive ? 'bg-success' : 'bg-secondary'} ms-1 status-badge`;
                    statusBadge.textContent = !isActive ? 'On' : 'Off';
                }
            });
        });
    });
    
    // Plan Growth Chart (for modal)
    const ctxGrowth = document.getElementById('planGrowthChart').getContext('2d');
    const growthChart = new Chart(ctxGrowth, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
                label: 'Subscribers',
                data: [5, 6, 7, 8, 9, 10, 11, 13, 14, 16, 17, 19],
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Subscribers'
                    }
                }
            }
        }
    });
    
    // Package Sales Chart (for modal)
    const ctxPackageSales = document.getElementById('packageSalesChart')?.getContext('2d');
    if (ctxPackageSales) {
        const packageSalesChart = new Chart(ctxPackageSales, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Sales',
                    data: [3, 5, 8, 9, 12, 15, 18, 22, 25, 28, 32, 35],
                    borderColor: '#36b9cc',
                    backgroundColor: 'rgba(54, 185, 204, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Sales'
                        }
                    }
                }
            }
        });
    }
    
    // Handle edit plan modal
    const editPlanModal = document.getElementById('editPlanModal');
    if (editPlanModal) {
        editPlanModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const planId = button.getAttribute('data-plan-id');
            fetchPlanData(planId);
        });
    }
    
    // Handle plan stats modal
    const planStatsModal = document.getElementById('planStatsModal');
    if (planStatsModal) {
        planStatsModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const planId = button.getAttribute('data-plan-id');
            
            // Dynamically update stats if needed
        });
    }
    
    // Handle edit package modal
    const editPackageModal = document.getElementById('editPackageModal');
    if (editPackageModal) {
        editPackageModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const packageId = button.getAttribute('data-package-id');
            fetchPackageData(packageId);
        });
    }
    
    // Handle package stats modal
    const packageStatsModal = document.getElementById('packageStatsModal');
    if (packageStatsModal) {
        packageStatsModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const packageId = button.getAttribute('data-package-id');
            
            // Dynamically update stats if needed
        });
    }
    
    // Handle promotion type toggle
    const promotionType = document.getElementById('promotionType');
    if (promotionType) {
        promotionType.addEventListener('change', function() {
            const discountFields = document.querySelector('.promotion-discount');
            const bonusFields = document.querySelector('.promotion-bonus-credits');
            
            if (this.value === 'discount') {
                discountFields.classList.remove('d-none');
                bonusFields.classList.add('d-none');
            } else if (this.value === 'bonus_credits') {
                discountFields.classList.add('d-none');
                bonusFields.classList.remove('d-none');
            } else {
                discountFields.classList.add('d-none');
                bonusFields.classList.add('d-none');
            }
        });
    }
    
    // Handle email schedule toggle
    const emailSchedule = document.getElementById('emailSchedule');
    if (emailSchedule) {
        emailSchedule.addEventListener('change', function() {
            const scheduleOptions = document.querySelector('.email-schedule-options');
            if (this.checked) {
                scheduleOptions.classList.remove('d-none');
            } else {
                scheduleOptions.classList.add('d-none');
            }
        });
    }
    
    // Handle edit subscription modal
    const editSubscriptionModal = document.getElementById('editSubscriptionModal');
    if (editSubscriptionModal) {
        editSubscriptionModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id') || 1;
            const userName = button.getAttribute('data-user-name') || 'John Smith';
            const userEmail = button.getAttribute('data-user-email') || 'john.smith@example.com';
            
            // Update the hidden userId field
            document.getElementById('editSubscriptionUserId').value = userId;
            
            // Update the form action with the correct user ID
            const form = document.getElementById('editSubscriptionForm');
            form.action = form.action.replace('/0', '/' + userId);
            
            // Update display in the modal
            const userNameElement = editSubscriptionModal.querySelector('.modal-body .fw-bold');
            const userEmailElement = editSubscriptionModal.querySelector('.modal-body .small.text-muted');
            userNameElement.textContent = userName;
            userEmailElement.textContent = userEmail;
        });
    }
    
    // Set default dates for promotion modal
    const today = new Date();
    const endDate = new Date();
    endDate.setDate(today.getDate() + 30);
    
    const promotionStartDate = document.getElementById('promotionStartDate');
    const promotionEndDate = document.getElementById('promotionEndDate');
    
    if (promotionStartDate && promotionEndDate) {
        promotionStartDate.valueAsDate = today;
        promotionEndDate.valueAsDate = endDate;
    }
    
    // Deletion and cancellation actions
    window.submitDeletePlanForm = function() {
        const planId = document.getElementById('editPlanId').value;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ path('app_admin_delete_subscription_plan', {'id': 'PLAN_ID'}) }}'.replace('PLAN_ID', planId);
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = '_csrf_token';
        csrfToken.value = '{{ csrf_token('delete_plan') }}';
        form.appendChild(csrfToken);
        
        const planIdInput = document.createElement('input');
        planIdInput.type = 'hidden';
        planIdInput.name = 'planId';
        planIdInput.value = planId;
        form.appendChild(planIdInput);
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    };
    
    window.submitCancelSubscriptionForm = function() {
        const userId = document.getElementById('editSubscriptionUserId').value;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ path('app_admin_cancel_user_subscription', {'id': 'USER_ID'}) }}'.replace('USER_ID', userId);
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = '_csrf_token';
        csrfToken.value = '{{ csrf_token('cancel_subscription') }}';
        form.appendChild(csrfToken);
        
        const userIdInput = document.createElement('input');
        userIdInput.type = 'hidden';
        userIdInput.name = 'userId';
        userIdInput.value = userId;
        form.appendChild(userIdInput);
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    };
    
    window.submitDeletePackageForm = function() {
        const packageId = document.getElementById('editPackageId').value;
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ path('app_admin_delete_package_addon', {'id': 'PACKAGE_ID'}) }}'.replace('PACKAGE_ID', packageId);
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = '_csrf_token';
        csrfToken.value = '{{ csrf_token('delete_package') }}';
        form.appendChild(csrfToken);
        
        const packageIdInput = document.createElement('input');
        packageIdInput.type = 'hidden';
        packageIdInput.name = 'packageId';
        packageIdInput.value = packageId;
        form.appendChild(packageIdInput);
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    };
    
    // Handle test email form submission
    window.submitTestEmailForm = function() {
        const form = document.getElementById('bulkEmailForm');
        const testEmailInput = document.createElement('input');
        testEmailInput.type = 'hidden';
        testEmailInput.name = 'isTest';
        testEmailInput.value = 'true';
        form.appendChild(testEmailInput);
        form.action = '{{ path('app_admin_send_test_email') }}';
        form.submit();
        form.removeChild(testEmailInput);
        form.action = '{{ path('app_admin_send_bulk_email') }}';
    };
    
    // Function to fetch plan data
    function fetchPlanData(planId) {
        // Get the form element without setting action yet
        const form = document.getElementById('editPlanForm');
        
        // Fetch plan data from the server using relative path from the document location
        // This ensures it works correctly with the base path
        const basePath = window.location.pathname.replace('/admin/subscriptions', '');
        fetch(`${basePath}/admin/subscriptions/${planId}/get`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to fetch plan data: ${response.status} ${response.statusText}`);
                }
                    return response.json();
                })
                .then(data => {
                    // Store the numeric ID for form submission
                    if (data.id) {
                        document.getElementById('editPlanId').value = data.id;
                        // Set form action with the numeric ID - this is the only place where we set the action
                        form.action = form.action.replace('/placeholder', '/' + data.id);
                    } else {
                        // Fallback to using the original planId if no id is returned
                        document.getElementById('editPlanId').value = planId;
                        form.action = form.action.replace('/placeholder', '/' + planId);
                    }
                    
                    // Populate the form fields with the retrieved data
                    document.getElementById('editPlanName').value = data.name || '';
                    document.getElementById('editPlanPrice').value = data.price || 0;
                    document.getElementById('editPlanCredits').value = data.credits || 0;
                    document.getElementById('editPlanDescription').value = data.description || '';
                    document.getElementById('editPlanTerm').value = data.term || 'monthly';
                    document.getElementById('editPlanDiscount').value = data.discount || 0;
                    document.getElementById('editPlanStripeID').value = data.stripeProductId || '';
                    document.getElementById('editPlanDisplayOrder').value = data.displayOrder || 1;
                    
                    // Ensure proper handling of display_order vs displayOrder properties
                    if (document.getElementById('editPlanDisplayOrder').value == 1 && data.display_order) {
                        document.getElementById('editPlanDisplayOrder').value = data.display_order;
                    }
                    
                    // Set checkboxes based on proper property names (both active/isActive and featured/isFeatured might be used)
                    const isFeatured = data.featured === true || data.featured === 1 || data.featured === "1" || 
                                    data.isFeatured === true || data.isFeatured === 1 || data.isFeatured === "1";
                    const isActive = data.active === true || data.active === 1 || data.active === "1" || 
                                  data.isActive === true || data.isActive === 1 || data.isActive === "1";
                    
                    document.getElementById('editPlanIsFeatured').checked = isFeatured;
                    document.getElementById('editPlanIsActive').checked = isActive;
                    
                    // Also set hidden inputs to ensure data is properly sent in the form
                    // Create or update hidden fields to ensure consistent data submission
                    let featuredField = document.getElementById('editPlanIsFeaturedValue');
                    if (!featuredField) {
                        featuredField = document.createElement('input');
                        featuredField.type = 'hidden';
                        featuredField.id = 'editPlanIsFeaturedValue';
                        featuredField.name = 'editPlanIsFeatured';
                        form.appendChild(featuredField);
                    }
                    featuredField.value = isFeatured ? '1' : '0';
                    
                    let activeField = document.getElementById('editPlanIsActiveValue');
                    if (!activeField) {
                        activeField = document.createElement('input');
                        activeField.type = 'hidden';
                        activeField.id = 'editPlanIsActiveValue';
                        activeField.name = 'editPlanIsActive';
                        form.appendChild(activeField);
                    }
                    activeField.value = isActive ? '1' : '0';
                    
                    // Update hidden values when checkboxes are toggled
                    document.getElementById('editPlanIsFeatured').addEventListener('change', function() {
                        document.getElementById('editPlanIsFeaturedValue').value = this.checked ? '1' : '0';
                    });
                    
                    document.getElementById('editPlanIsActive').addEventListener('change', function() {
                        document.getElementById('editPlanIsActiveValue').value = this.checked ? '1' : '0';
                    });
                    
                    // Set feature checkboxes
                    if (data.features) {
                        document.getElementById('editFeatureProductDesc').checked = data.features.product_descriptions || false;
                        document.getElementById('editFeatureMetaDesc').checked = data.features.meta_descriptions || false;
                        document.getElementById('editFeatureImageAlt').checked = data.features.image_alt_text || false;
                        document.getElementById('editFeatureSeoKeywords').checked = data.features.seo_keywords || false;
                        document.getElementById('editFeaturePremiumAI').checked = data.features.premium_ai || false;
                    }
                })
                .catch(error => {
                    console.error('Error fetching plan data:', error);
                    alert(`Failed to load plan data: ${error.message}. Please check the browser console for details.`);
                });
    }
    
    // Function to fetch package data
    function fetchPackageData(packageId) {
        // Get DOM elements
        const form = document.getElementById('editPackageForm');
        const modalBody = editPackageModal.querySelector('.modal-body');
        
        // Clear any existing error messages
        const existingAlerts = modalBody.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());
        
        // Set hidden ID field
        document.getElementById('editPackageId').value = packageId;
        
        // Display loading indicator
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'text-center my-4 position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75';
        loadingIndicator.style.zIndex = '1050';
        loadingIndicator.innerHTML = '<div class="position-absolute top-50 start-50 translate-middle"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading package data...</p></div>';
        modalBody.style.position = 'relative';
        modalBody.appendChild(loadingIndicator);
        
        // Disable form inputs while loading
        const formInputs = form.querySelectorAll('input, select, textarea, button');
        formInputs.forEach(input => input.disabled = true);
        
        // Use the same URL construction approach as fetchPlanData for consistency
        // Extract base path the same way as the working fetchPlanData function
        const basePath = window.location.pathname.replace('/admin/subscriptions', '');
        
        // Try the correct endpoint pattern with path matching the controller route
        const apiUrl = `${basePath}/admin/subscriptions/package/${packageId}/get`;
        console.log('Fetching package data from:', apiUrl);
        
        // Helper function to safely set form field values
        function setFormValue(fieldId, value, fallback = '') {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = (value !== undefined && value !== null) ? value : fallback;
                console.log(`Set ${fieldId} to:`, field.value);
            } else {
                console.warn(`Field ${fieldId} not found`);
            }
        }
        
        // Helper function to safely set checkbox state
        function setCheckboxState(fieldId, value) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.checked = value === true || value === 1 || value === '1' || 
                               value === 'true' || value === 'yes' || value === 'on';
                console.log(`Set ${fieldId} checked state to:`, field.checked);
            } else {
                console.warn(`Checkbox ${fieldId} not found`);
            }
        }
        
        // Helper function to load fallback data from the card UI
        function loadFallbackDataFromCard(button) {
            try {
                const packageCard = button.closest('.subscription-plan-card');
                if (packageCard) {
                    // Get name from card heading
                    const nameElement = packageCard.querySelector('h3');
                    if (nameElement) setFormValue('editPackageName', nameElement.textContent.trim());
                    
                    // Get prices
                    const priceStandardElement = packageCard.querySelector('.h1.mb-0');
                    if (priceStandardElement) {
                        setFormValue('editPackagePriceStandard', 
                            priceStandardElement.textContent.replace('$', '').trim());
                    }
                    
                    const pricePremiumElement = packageCard.querySelector('.h5.mt-2');
                    if (pricePremiumElement) {
                        setFormValue('editPackagePricePremium', 
                            pricePremiumElement.textContent.replace('$', '').trim());
                    }
                    
                    // Get credits
                    const creditsElement = packageCard.querySelector('.badge.bg-warning');
                    if (creditsElement) {
                        const creditsMatch = creditsElement.textContent.match(/(\d+)/);
                        if (creditsMatch) setFormValue('editPackageCredits', creditsMatch[1]);
                    }
                    
                    // Set active state
                    const isActiveElement = packageCard.querySelector('.badge.bg-success');
                    setCheckboxState('editPackageIsActive', isActiveElement !== null);
                    
                    console.log('Loaded fallback data from card UI');
                }
            } catch (fallbackError) {
                console.error('Failed to apply fallback data from card:', fallbackError);
            }
        }
        
        // Helper function to show API error message
        function showApiErrorMessage(error) {
            // Remove any existing alert
            const existingAlert = modalBody.querySelector('.alert-danger');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Show error message
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger';
            errorAlert.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i> 
                <strong>Error loading package data:</strong> ${error.message || 'Unknown error'}
                <div class="small mt-1">Some fields have been pre-filled from the package card. You may need to re-enter some details.</div>
            `;
            modalBody.insertBefore(errorAlert, form);
            
            // Make sure form inputs are enabled
            formInputs.forEach(input => input.disabled = false);
        }
        
        // Actually perform the fetch request
        // Use the same endpoint format as the plan fetching which is known to work
        const correctApiUrl = `${basePath}/admin/subscriptions/package/${packageId}/get`;
        console.log('Using corrected package data URL:', correctApiUrl);
        
        fetch(correctApiUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received package data:', data);
            
            // Remove the loading indicator
            if (loadingIndicator.parentNode) {
                modalBody.removeChild(loadingIndicator);
            }
            
            // Re-enable form inputs
            formInputs.forEach(input => input.disabled = false);
            
            // Store the numeric ID for form submission
            if (data.id) {
                document.getElementById('editPackageId').value = data.id;
                // Update form action with the correct ID
                form.action = form.action.replace('/placeholder', '/' + data.id);
            }
            
            // Populate the form fields with data from API response
            // Handle both snake_case and camelCase field names
            setFormValue('editPackageName', data.name);
            setFormValue('editPackagePriceStandard', data.price_standard || data.priceStandard);
            setFormValue('editPackagePricePremium', data.price_premium || data.pricePremium);
            setFormValue('editPackageCredits', data.credits);
            setFormValue('editPackageDescription', data.description);
            setFormValue('editPackageDiscount', data.discount, '0');
            setFormValue('editPackageStripeID', data.stripe_product_id || data.stripeProductId);
            setFormValue('editPackageStripePriceStandard', data.stripe_price_id_standard || data.stripePriceStandard);
            setFormValue('editPackageStripePricePremium', data.stripe_price_id_premium || data.stripePricePremium);
            setFormValue('editPackageDisplayOrder', data.display_order || data.displayOrder, '1');
            
            // Set checkbox states
            setCheckboxState('editPackageIsFeatured', data.is_featured || data.isFeatured);
            setCheckboxState('editPackageIsActive', data.is_active || data.isActive);
            
            // Display success message
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success';
            successAlert.innerHTML = `<i class="fas fa-check-circle me-2"></i> Package data loaded successfully.`;
            modalBody.insertBefore(successAlert, form);
            
            // Auto-dismiss success message after 3 seconds
            setTimeout(() => {
                if (successAlert.parentNode) {
                    successAlert.parentNode.removeChild(successAlert);
                }
            }, 3000);
        })
        .catch(error => {
            console.error('Error loading package data:', error);
            
            // Remove loading indicator
            if (loadingIndicator.parentNode) {
                modalBody.removeChild(loadingIndicator);
            }
            
        // Access the button that triggered the modal from event.relatedTarget stored at the modal level
        const triggerButton = document.querySelector(`button[data-bs-toggle="modal"][data-bs-target="#editPackageModal"][data-package-id="${packageId}"]`);
        if (triggerButton) {
            loadFallbackDataFromCard(triggerButton);
        } else {
            console.warn('Could not find trigger button for fallback data');
        }
            
            // Show error message
            showApiErrorMessage(error);
            
            // Re-enable form inputs
            formInputs.forEach(input => input.disabled = false);
        });
    }
});
</script>
{% endblock %}
