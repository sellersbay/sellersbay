{% extends 'base.html.twig' %}

{% block title %}Product Management - Admin - RoboSEO{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .admin-nav .nav-link {
            color: #4e73df;
            padding: 1rem;
            border-radius: 0.35rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        
        .admin-nav .nav-link:hover {
            background-color: #eaecf4;
        }
        
        .admin-nav .nav-link.active {
            background-color: #4e73df;
            color: white;
        }
        
        .admin-nav .nav-link i {
            margin-right: 0.5rem;
        }
        
        .filter-form label {
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #4e73df;
        }
        
        .table-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .product-status.imported {
            color: #858796;
        }
        
        .product-status.ai_processed {
            color: #4e73df;
        }
        
        .product-status.exported {
            color: #1cc88a;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">Product Management</h1>
            <p class="text-muted">Manage all products in the system.</p>
        </div>
    </div>

    <div class="row">
        <!-- Admin Navigation Sidebar -->
        <div class="col-xl-3 col-lg-4 mb-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Admin Navigation</h6>
                </div>
                <div class="card-body">
                    <div class="admin-nav">
                        <a href="{{ path('app_admin_dashboard') }}" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                        <a href="{{ path('app_admin_users') }}" class="nav-link">
                            <i class="fas fa-users"></i> User Management
                        </a>
                        <a href="{{ path('app_admin_products') }}" class="nav-link active">
                            <i class="fas fa-box"></i> Product Management
                        </a>
                        <a href="{{ path('app_admin_credits') }}" class="nav-link">
                            <i class="fas fa-coins"></i> Credits Management
                        </a>
                        <a href="{{ path('app_admin_subscriptions') }}" class="nav-link">
                            <i class="fas fa-receipt"></i> Subscription Plans
                        </a>
                        <a href="{{ path('app_admin_statistics') }}" class="nav-link">
                            <i class="fas fa-chart-bar"></i> System Statistics
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success btn-sm">
                            <i class="fas fa-file-export"></i> Export Products
                        </button>
                        <button type="button" class="btn btn-primary btn-sm">
                            <i class="fas fa-sync"></i> Sync WooCommerce
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" id="bulkActionsBtn" disabled>
                            <i class="fas fa-cogs"></i> Bulk Actions <span class="badge bg-white text-danger" id="selectedCount">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="col-xl-9 col-lg-8">
            <!-- Filters Card -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Filters</h6>
                </div>
                <div class="card-body">
                    <form class="filter-form">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="filterUser" class="form-label">USER</label>
                                <select class="form-select" id="filterUser" name="user">
                                    <option value="">All Users</option>
                                    {% for user in users %}
                                        <option value="{{ user.id }}">{{ user.firstName }} {{ user.lastName }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filterStatus" class="form-label">STATUS</label>
                                <select class="form-select" id="filterStatus" name="status">
                                    <option value="">All Statuses</option>
                                    <option value="imported">Imported</option>
                                    <option value="ai_processed">AI Processed</option>
                                    <option value="exported">Exported</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="filterCategory" class="form-label">CATEGORY</label>
                                <select class="form-select" id="filterCategory" name="category">
                                    <option value="">All Categories</option>
                                    <option value="electronics">Electronics</option>
                                    <option value="clothing">Clothing</option>
                                    <option value="home">Home & Kitchen</option>
                                    <option value="beauty">Beauty & Personal Care</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="searchTerm" class="form-label">SEARCH</label>
                                <input type="text" class="form-control" id="searchTerm" name="search" placeholder="Product name, description, etc.">
                            </div>
                            <div class="col-md-4">
                                <label for="dateRange" class="form-label">DATE RANGE</label>
                                <select class="form-select" id="dateRange" name="dateRange">
                                    <option value="">Any Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="button" class="btn btn-primary me-2" id="applyFiltersBtn">
                                    <i class="fas fa-filter"></i> Apply Filters
                                </button>
                                <button type="button" class="btn btn-secondary" id="resetFiltersBtn">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                                <input type="hidden" name="_token" value="{{ csrf_token('filter_products') }}">
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Products Table -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">All Products</h6>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                            <li><a class="dropdown-item" href="#">Export as CSV</a></li>
                            <li><a class="dropdown-item" href="#">Export as Excel</a></li>
                            <li><a class="dropdown-item" href="#">Export as PDF</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="productsTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th width="20">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAll">
                                        </div>
                                    </th>
                                    <th>ID</th>
                                    <th>Product</th>
                                    <th>User</th>
                                    <th>Status</th>
                                    <th>WooCommerce ID</th>
                                    <th>Date Added</th>
                                    <th width="120">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in products %}
                                    <tr>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input product-select" type="checkbox" 
                                                       data-product-id="{{ product.id }}">
                                            </div>
                                        </td>
                                        <td>{{ product.id }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if product.imageUrl %}
                                                    <img src="{{ product.imageUrl }}" alt="{{ product.name }}" class="img-thumbnail me-2" style="width: 50px; height: 50px; object-fit: cover;">
                                                {% else %}
                                                    <div class="bg-light d-flex align-items-center justify-content-center me-2" style="width: 50px; height: 50px;">
                                                        <i class="fas fa-box text-muted"></i>
                                                    </div>
                                                {% endif %}
                                                <div>
                                                    <div class="fw-bold">{{ product.name }}</div>
                                                    <div class="text-muted small">{{ product.shortDescription|default('')|length > 50 ? product.shortDescription|slice(0, 50) ~ '...' : product.shortDescription|default('No description') }}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <a href="{{ path('app_admin_user_view', {'id': product.owner.id}) }}">
                                                {{ product.owner.firstName }} {{ product.owner.lastName }}
                                            </a>
                                        </td>
                                        <td>
                                            {% if product.status == 'imported' %}
                                                <i class="fas fa-file-import product-status imported me-1"></i>
                                                <span>Imported</span>
                                            {% elseif product.status == 'ai_processed' %}
                                                <i class="fas fa-robot product-status ai_processed me-1"></i>
                                                <span>AI Processed</span>
                                            {% elseif product.status == 'exported' %}
                                                <i class="fas fa-file-export product-status exported me-1"></i>
                                                <span>Exported</span>
                                            {% else %}
                                                <span>{{ product.status|capitalize }}</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ product.woocommerceId }}</td>
                                        <td>{{ product.createdAt|date('Y-m-d') }}</td>
                                        <td class="table-actions">
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ path('app_admin_product_view', {'id': product.id}) }}" 
                                                   class="btn btn-info" title="View Product">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <button type="button" class="btn btn-primary" title="Generate AI Content"
                                                        data-bs-toggle="modal" data-bs-target="#generateAIModal"
                                                        data-product-id="{{ product.id }}"
                                                        data-product-name="{{ product.name }}">
                                                    <i class="fas fa-robot"></i>
                                                </button>
                                                <button type="button" class="btn btn-success" title="Export to WooCommerce"
                                                        data-bs-toggle="modal" data-bs-target="#exportProductModal"
                                                        data-product-id="{{ product.id }}"
                                                        data-product-name="{{ product.name }}">
                                                    <i class="fas fa-file-export"></i>
                                                </button>
                                                <button type="button" class="btn btn-danger" title="Delete Product"
                                                        data-bs-toggle="modal" data-bs-target="#deleteProductModal"
                                                        data-product-id="{{ product.id }}"
                                                        data-product-name="{{ product.name }}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span class="text-muted">Showing {{ products|length }} products</span>
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item">
                                    <a class="page-link" href="#" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Generate AI Content Modal -->
<div class="modal fade" id="generateAIModal" tabindex="-1" aria-labelledby="generateAIModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateAIModalLabel">Generate AI Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Generate AI content for product: <strong id="aiProductName"></strong></p>
                <form id="generateAIForm" action="{{ path('app_admin_product_generate_ai', {'id': 'PRODUCT_ID'}) }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('generate_ai') }}">
                    <input type="hidden" id="aiProductId" name="productId">
                    <div class="mb-3">
                        <label for="aiGenerationType" class="form-label">Generation Type</label>
                        <select class="form-select" id="aiGenerationType">
                            <option value="standard">Standard Generation</option>
                            <option value="premium">Premium Generation</option>
                        </select>
                        <small class="form-text text-muted">
                            Premium generation uses GPT-4 and includes additional content types.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label for="aiGenerationOptions" class="form-label">Options</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="generateDescription" checked>
                            <label class="form-check-label" for="generateDescription">
                                Product Description
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="generateShortDescription" checked>
                            <label class="form-check-label" for="generateShortDescription">
                                Short Description
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="generateMetaDescription" checked>
                            <label class="form-check-label" for="generateMetaDescription">
                                Meta Description
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="generateImageAltText" checked>
                            <label class="form-check-label" for="generateImageAltText">
                                Image Alt Text
                            </label>
                        </div>
                        <div class="premium-options">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="generateSeoKeywords">
                                <label class="form-check-label" for="generateSeoKeywords">
                                    SEO Keywords (Premium)
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="generateSocialMediaPost">
                                <label class="form-check-label" for="generateSocialMediaPost">
                                    Social Media Post (Premium)
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generateAIBtn" onclick="submitGenerateAIForm()">Generate Content</button>
            </div>
        </div>
    </div>
</div>

<!-- Export Product Modal -->
<div class="modal fade" id="exportProductModal" tabindex="-1" aria-labelledby="exportProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportProductModalLabel">Export to WooCommerce</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Export product to WooCommerce: <strong id="exportProductName"></strong></p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span>This will overwrite the product content in WooCommerce.</span>
                </div>
                <form id="exportProductForm" action="{{ path('app_admin_product_export', {'id': 'PRODUCT_ID'}) }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('export_product') }}">
                    <input type="hidden" id="exportProductId" name="productId">
                    <div class="mb-3">
                        <label for="exportOptions" class="form-label">Export Options</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="exportDescription" checked>
                            <label class="form-check-label" for="exportDescription">
                                Product Description
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="exportShortDescription" checked>
                            <label class="form-check-label" for="exportShortDescription">
                                Short Description
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="exportMetaDescription" checked>
                            <label class="form-check-label" for="exportMetaDescription">
                                Meta Description
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="exportImageAltText" checked>
                            <label class="form-check-label" for="exportImageAltText">
                                Image Alt Text
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="exportProductBtn" onclick="submitExportForm()">Export to WooCommerce</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Product Modal -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteProductModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the product <strong id="deleteProductName"></strong>?</p>
                <p class="text-danger">This action cannot be undone. The product will be permanently deleted from the system.</p>
                <form id="deleteProductForm" action="{{ path('app_admin_product_delete', {'id': 'PRODUCT_ID'}) }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('delete_product') }}">
                    <input type="hidden" id="deleteProductId" name="productId">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                        <label class="form-check-label" for="confirmDelete">
                            I understand this action is permanent and cannot be undone
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="deleteFromWooCommerce">
                        <label class="form-check-label" for="deleteFromWooCommerce">
                            Also delete this product from WooCommerce (if connected)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteProductBtn" disabled onclick="submitDeleteForm()">Delete Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1" aria-labelledby="bulkActionsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkActionsModalLabel">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Apply action to <span id="bulkCount">0</span> selected products:</p>
                <form id="bulkActionsForm" action="{{ path('app_admin_product_bulk_action') }}" method="POST">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token('bulk_action') }}">
                    <input type="hidden" name="selectedProducts" id="selectedProductsInput">
                    <div class="mb-3">
                        <label for="bulkAction" class="form-label">Action</label>
                        <select class="form-select" id="bulkAction">
                            <option value="">Select an action...</option>
                            <option value="generate_ai">Generate AI Content</option>
                            <option value="export_woocommerce">Export to WooCommerce</option>
                            <option value="change_status">Change Status</option>
                            <option value="delete">Delete Products</option>
                        </select>
                    </div>
                    
                    <!-- Conditional fields based on action -->
                    <div id="bulkGenerateAIFields" class="d-none">
                        <div class="mb-3">
                            <label for="bulkAIGenerationType" class="form-label">Generation Type</label>
                            <select class="form-select" id="bulkAIGenerationType">
                                <option value="standard">Standard Generation</option>
                                <option value="premium">Premium Generation</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="bulkStatusFields" class="d-none">
                        <div class="mb-3">
                            <label for="bulkStatus" class="form-label">Status</label>
                            <select class="form-select" id="bulkStatus">
                                <option value="imported">Imported</option>
                                <option value="ai_processed">AI Processed</option>
                                <option value="exported">Exported</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="bulkDeleteFields" class="d-none">
                        <div class="alert alert-danger">
                            This will permanently delete all selected products. This action cannot be undone.
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="bulkConfirmDelete">
                            <label class="form-check-label" for="bulkConfirmDelete">
                                I understand this action is permanent and cannot be undone
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="bulkDeleteFromWooCommerce">
                            <label class="form-check-label" for="bulkDeleteFromWooCommerce">
                                Also delete selected products from WooCommerce (if connected)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyBulkActionBtn" onclick="submitBulkActionsForm()">Apply Action</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filters functionality
    const filterForm = document.querySelector('.filter-form');
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    const resetFiltersBtn = document.getElementById('resetFiltersBtn');
    const productsTable = document.getElementById('productsTable').querySelector('tbody');
    
    // Handle Apply Filters button click
    applyFiltersBtn.addEventListener('click', function() {
        const formData = new FormData(filterForm);
        
        // AJAX request to filter products
        fetch('{{ path('app_admin_products_filter') }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // Clear table body
            productsTable.innerHTML = '';
            
            // Check if any products found
            if (data.products.length === 0) {
                const noResultsRow = document.createElement('tr');
                noResultsRow.innerHTML = '<td colspan="8" class="text-center">No products found matching your filters.</td>';
                productsTable.appendChild(noResultsRow);
                return;
            }
            
            // Add filtered products to table
            data.products.forEach(product => {
                const row = document.createElement('tr');
                
                // Create status badge based on status
                let statusBadge = '';
                if (product.status === 'imported') {
                    statusBadge = '<i class="fas fa-file-import product-status imported me-1"></i><span>Imported</span>';
                } else if (product.status === 'ai_processed') {
                    statusBadge = '<i class="fas fa-robot product-status ai_processed me-1"></i><span>AI Processed</span>';
                } else if (product.status === 'exported') {
                    statusBadge = '<i class="fas fa-file-export product-status exported me-1"></i><span>Exported</span>';
                }
                
                // Format short description
                const shortDesc = product.shortDescription || 'No description';
                const formattedShortDesc = shortDesc.length > 50 ? shortDesc.substring(0, 50) + '...' : shortDesc;
                
                row.innerHTML = `
                    <td>
                        <div class="form-check">
                            <input class="form-check-input product-select" type="checkbox" data-product-id="${product.id}">
                        </div>
                    </td>
                    <td>${product.id}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${product.imageUrl ? 
                                `<img src="${product.imageUrl}" alt="${product.name}" class="img-thumbnail me-2" style="width: 50px; height: 50px; object-fit: cover;">` : 
                                `<div class="bg-light d-flex align-items-center justify-content-center me-2" style="width: 50px; height: 50px;"><i class="fas fa-box text-muted"></i></div>`
                            }
                            <div>
                                <div class="fw-bold">${product.name}</div>
                                <div class="text-muted small">${formattedShortDesc}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <a href="${window.location.origin}/sellersbay/ecommerce-tools/public/admin/user/${product.owner.id}">
                            ${product.owner.firstName} ${product.owner.lastName}
                        </a>
                    </td>
                    <td>${statusBadge}</td>
                    <td>${product.woocommerceId || '-'}</td>
                    <td>${product.createdAt}</td>
                    <td class="table-actions">
                        <a href="${window.location.origin}/sellersbay/ecommerce-tools/public/admin/product/${product.id}" class="btn btn-primary btn-sm">
                            <i class="fas fa-eye"></i>
                        </a>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#exportProductModal" 
                                data-product-id="${product.id}" data-product-name="${product.name}">
                            <i class="fas fa-file-export"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteProductModal"
                                data-product-id="${product.id}" data-product-name="${product.name}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                productsTable.appendChild(row);
            });
            
            // Reinitialize checkboxes event listeners
            initCheckboxes();
        })
        .catch(error => {
            console.error('Error filtering products:', error);
            alert('An error occurred while filtering products. Please try again.');
        });
    });
    
    // Handle Reset Filters button click
    resetFiltersBtn.addEventListener('click', function() {
        // Reset form values
        filterForm.reset();
        
        // Reload page to show all products
        window.location.reload();
    });
    
    // Initialize checkbox event listeners function
    function initCheckboxes() {
        const productCheckboxes = document.querySelectorAll('.product-select');
        const selectAllCheckbox = document.getElementById('selectAll');
        
        // Clear select all checkbox
        if (selectAllCheckbox) {
            selectAllCheckbox.checked = false;
        }
        
        // Handle individual checkboxes
        productCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectedCount();
                // Update select all checkbox state
                if (!this.checked && selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                } else if (selectAllCheckbox) {
                    // Check if all checkboxes are checked
                    const allChecked = Array.from(productCheckboxes).every(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                }
            });
        });
        
        // Update selected count
        updateSelectedCount();
    }
    
    // Form submission functions
    window.submitGenerateAIForm = function() {
        // Update form action with the correct product ID
        const form = document.getElementById('generateAIForm');
        const productId = document.getElementById('aiProductId').value;
        form.action = form.action.replace('PRODUCT_ID', productId);
        form.submit();
    };
    
    window.submitExportForm = function() {
        // Update form action with the correct product ID
        const form = document.getElementById('exportProductForm');
        const productId = document.getElementById('exportProductId').value;
        form.action = form.action.replace('PRODUCT_ID', productId);
        form.submit();
    };
    
    window.submitDeleteForm = function() {
        // Update form action with the correct product ID
        const form = document.getElementById('deleteProductForm');
        const productId = document.getElementById('deleteProductId').value;
        form.action = form.action.replace('PRODUCT_ID', productId);
        form.submit();
    };
    
    window.submitBulkActionsForm = function() {
        // Gather all selected product IDs
        const selectedProducts = [];
        document.querySelectorAll('.product-select:checked').forEach(checkbox => {
            selectedProducts.push(checkbox.getAttribute('data-product-id'));
        });
        
        // Update hidden input with selected products
        document.getElementById('selectedProductsInput').value = selectedProducts.join(',');
        
        // Submit the form
        document.getElementById('bulkActionsForm').submit();
    };
    
    // Handle select all checkbox
    const selectAllCheckbox = document.getElementById('selectAll');
    const productCheckboxes = document.querySelectorAll('.product-select');
    const bulkActionsBtn = document.getElementById('bulkActionsBtn');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    selectAllCheckbox.addEventListener('change', function() {
        productCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updateSelectedCount();
    });
    
    // Handle individual checkboxes
    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
            // Update select all checkbox state
            if (!this.checked) {
                selectAllCheckbox.checked = false;
            } else {
                // Check if all checkboxes are checked
                const allChecked = Array.from(productCheckboxes).every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked;
            }
        });
    });
    
    // Update selected count
    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.product-select:checked').length;
        selectedCountSpan.textContent = selectedCount;
        bulkActionsBtn.disabled = selectedCount === 0;
    }
    
    // Handle bulk actions button
    bulkActionsBtn.addEventListener('click', function() {
        const bulkCountSpan = document.getElementById('bulkCount');
        bulkCountSpan.textContent = document.querySelectorAll('.product-select:checked').length;
        
        // Show modal
        const bulkActionsModal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
        bulkActionsModal.show();
    });
    
    // Handle bulk action selection
    const bulkActionSelect = document.getElementById('bulkAction');
    bulkActionSelect.addEventListener('change', function() {
        // Hide all conditional fields
        document.getElementById('bulkGenerateAIFields').classList.add('d-none');
        document.getElementById('bulkStatusFields').classList.add('d-none');
        document.getElementById('bulkDeleteFields').classList.add('d-none');
        
        // Show relevant fields based on selection
        switch(this.value) {
            case 'generate_ai':
                document.getElementById('bulkGenerateAIFields').classList.remove('d-none');
                break;
            case 'change_status':
                document.getElementById('bulkStatusFields').classList.remove('d-none');
                break;
            case 'delete':
                document.getElementById('bulkDeleteFields').classList.remove('d-none');
                break;
        }
    });
    
    // Handle Generate AI modal
    const generateAIModal = document.getElementById('generateAIModal');
    generateAIModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const productId = button.getAttribute('data-product-id');
        const productName = button.getAttribute('data-product-name');
        
        document.getElementById('aiProductId').value = productId;
        document.getElementById('aiProductName').textContent = productName;
    });
    
    // Handle Export Product modal
    const exportProductModal = document.getElementById('exportProductModal');
    exportProductModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const productId = button.getAttribute('data-product-id');
        const productName = button.getAttribute('data-product-name');
        
        document.getElementById('exportProductId').value = productId;
        document.getElementById('exportProductName').textContent = productName;
    });
    
    // Handle Delete Product modal
    const deleteProductModal = document.getElementById('deleteProductModal');
    deleteProductModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const productId = button.getAttribute('data-product-id');
        const productName = button.getAttribute('data-product-name');
        
        document.getElementById('deleteProductId').value = productId;
        document.getElementById('deleteProductName').textContent = productName;
    });
    
    // Handle confirm delete checkbox
    const confirmDeleteCheckbox = document.getElementById('confirmDelete');
    const deleteProductBtn = document.getElementById('deleteProductBtn');
    
    if (confirmDeleteCheckbox && deleteProductBtn) {
        confirmDeleteCheckbox.addEventListener('change', function() {
            deleteProductBtn.disabled = !this.checked;
        });
    }
    
    // Handle AI generation type changes
    const aiGenerationType = document.getElementById('aiGenerationType');
    const premiumOptions = document.querySelectorAll('.premium-options .form-check-input');
    
    if (aiGenerationType && premiumOptions.length > 0) {
        aiGenerationType.addEventListener('change', function() {
            const isPremium = this.value === 'premium';
            premiumOptions.forEach(option => {
                option.disabled = !isPremium;
                if (!isPremium) {
                    option.checked = false;
                }
            });
        });
        
        // Initialize premium options state
        const isPremium = aiGenerationType.value === 'premium';
        premiumOptions.forEach(option => {
            option.disabled = !isPremium;
        });
    }
    
    // Initialize with correct selected count
    updateSelectedCount();
});
</script>
{% endblock %}