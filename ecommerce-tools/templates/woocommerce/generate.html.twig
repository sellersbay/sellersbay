{% extends 'base.html.twig' %}

{% block title %}{% if edit_mode %}Edit SEO Content{% else %}Generate SEO Content{% endif %} - RoboSEO{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .editor-toolbar {
            background: #f8f9fa;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-bottom: none;
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
        }
        .editor-toolbar .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .editor-content {
            border: 1px solid #dee2e6;
            border-top: none;
            min-height: 250px;
            padding: 1rem;
            overflow-y: auto;
            background: white;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }
        .editor-content:focus {
            outline: none;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .editor-content p {
            margin-bottom: 1rem;
        }
        .editor-content ul, .editor-content ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }
        .editor-content h2, .editor-content h3, .editor-content h4 {
            margin-bottom: 1rem;
            font-weight: 600;
        }
        /* Hidden textarea to store HTML value */
        #editorHiddenContent {
            display: none;
        }
        /* Styles for the Current Content section */
        .current-content-section h6 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
        }
        .current-content-section .content-block {
            margin-bottom: 1.5rem;
        }
        .current-content-section .description-content {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            min-height: 100px;
        }
        .current-content-section .description-content p {
            margin-bottom: 1rem;
        }
        .current-content-section .description-content ul, 
        .current-content-section .description-content ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }
        .current-content-section .description-content h2, 
        .current-content-section .description-content h3, 
        .current-content-section .description-content h4 {
            margin-bottom: 1rem;
            font-weight: 600;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="h3 mb-0">{% if edit_mode %}Edit SEO Content{% else %}Generate SEO Content{% endif %}</h1>
                        <div>
                            <a href="{{ path('app_woocommerce_dashboard') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Back to WooCommerce Dashboard
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% for flash_error in app.flashes('error') %}
                        <div class="alert alert-danger" role="alert">{{ flash_error }}</div>
                    {% endfor %}

                    {% for flash_success in app.flashes('success') %}
                        <div class="alert alert-success" role="alert">{{ flash_success }}</div>
                    {% endfor %}

                    {% if not edit_mode %}
                    <div class="alert alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-coins fa-2x"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="alert-heading mb-1">Credit Usage</h5>
                                <p class="mb-0">
                                    You have {{ app.user.credits }} credits remaining.
                                    {% if is_granted('ROLE_PREMIUM') %}
                                        <span class="badge bg-primary ms-2">Premium User</span>
                                    {% endif %}
                                </p>
                                <div class="mt-2">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="processingMode" id="standardProcessing" value="standard">
                                        <label class="form-check-label" for="standardProcessing">
                                            Standard Processing (0.5 credit) - Uses GPT-3.5 Turbo
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="processingMode" id="premiumProcessing" value="premium" checked>
                                        <label class="form-check-label" for="premiumProcessing">
                                            Premium Processing (1 credit) - Uses GPT-4 Turbo
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if is_granted('ROLE_PREMIUM') %}
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary bg-opacity-10">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-crown text-primary me-2"></i>
                                <h5 class="card-title mb-0">Premium Features</h5>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="premiumOptionsForm">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="targetKeywords" class="form-label">Target Keywords</label>
                                            <input type="text" class="form-control" id="targetKeywords" placeholder="e.g. organic cotton, sustainable, eco-friendly">
                                            <div class="form-text">Separate multiple keywords with commas</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="competitorUrls" class="form-label">Competitor URLs</label>
                                            <input type="text" class="form-control" id="competitorUrls" placeholder="e.g. competitor.com/product">
                                            <div class="form-text">Separate multiple URLs with commas</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="contentTone" class="form-label">Content Tone</label>
                                            <select class="form-select" id="contentTone">
                                                <option value="professional">Professional</option>
                                                <option value="casual">Casual/Friendly</option>
                                                <option value="luxury">Luxury/Premium</option>
                                                <option value="technical">Technical</option>
                                                <option value="persuasive">Persuasive</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="usePremiumFeatures" checked>
                                    <label class="form-check-label" for="usePremiumFeatures">Enable enhanced premium features</label>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                    <div class="row mb-4">
                        {% if not edit_mode %}
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Current Content</h5>
                                </div>
                                <div class="card-body current-content-section">
                                    <div class="content-block">
                                        <h6>Product Name</h6>
                                        <p>{{ product.name }}</p>
                                    </div>

                                    <div class="content-block">
                                        <h6>Description</h6>
                                        <div class="description-content">{{ product.description|raw }}</div>
                                    </div>

                                    <div class="content-block">
                                        <h6>Short Description</h6>
                                        <div class="description-content">{{ product.shortDescription|raw }}</div>
                                    </div>

                                    <div class="content-block">
                                        <h6>Meta Title</h6>
                                        <p>{{ product.metaTitle }}</p>
                                    </div>
                                    
                                    <div class="content-block">
                                        <h6>Target Keyphrase</h6>
                                        <p>{{ product.targetKeyphrase }}</p>
                                    </div>
                                    
                                    <div class="content-block">
                                        <h6>Meta Description</h6>
                                        <p>{{ product.metaDescription }}</p>
                                    </div>

                                    <div class="content-block">
                                        <h6>Image Alt Text</h6>
                                        <p>{{ product.imageAltText }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-{{ edit_mode ? '12' : '6' }}">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">{% if edit_mode %}Edit Content{% else %}Generated Content{% endif %}</h5>
                                </div>
                                <div class="card-body">
                                    <div id="generationProgress" class="d-none">
                                        <div class="py-4">
                                            <h5 class="text-center mb-3" id="generationStatus">Generating SEO content...</h5>
                                            <div class="progress mb-3" style="height: 24px;">
                                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                                    role="progressbar" style="width: 0%" 
                                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                            <p class="text-muted text-center small mb-0" id="generationStepDetail">
                                                Initializing AI model...
                                            </p>
                                        </div>
                                    </div>

                                    <div id="generatedContent" class="{{ edit_mode ? '' : 'd-none' }}">
                                        <div class="mb-4">
                                            <label class="form-label">Description</label>
                                            <!-- Custom WYSIWYG Editor -->
                                            <div class="editor-toolbar">
                                                <div class="btn-group mb-2 me-2">
                                                    <button type="button" class="btn btn-outline-secondary" data-command="formatBlock" data-value="p">
                                                        <i class="fas fa-paragraph"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" data-command="formatBlock" data-value="h2">H2</button>
                                                    <button type="button" class="btn btn-outline-secondary" data-command="formatBlock" data-value="h3">H3</button>
                                                </div>
                                                <div class="btn-group mb-2 me-2">
                                                    <button type="button" class="btn btn-outline-secondary" data-command="bold">
                                                        <i class="fas fa-bold"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" data-command="italic">
                                                        <i class="fas fa-italic"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" data-command="underline">
                                                        <i class="fas fa-underline"></i>
                                                    </button>
                                                </div>
                                                <div class="btn-group mb-2 me-2">
                                                    <button type="button" class="btn btn-outline-secondary" data-command="insertUnorderedList">
                                                        <i class="fas fa-list-ul"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" data-command="insertOrderedList">
                                                        <i class="fas fa-list-ol"></i>
                                                    </button>
                                                </div>
                                                <div class="btn-group mb-2">
                                                    <button type="button" class="btn btn-outline-secondary" data-command="createLink" title="Insert Link">
                                                        <i class="fas fa-link"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" data-command="removeFormat" title="Clear Formatting">
                                                        <i class="fas fa-eraser"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <!-- Editable content area -->
                                            <div class="editor-content" id="editor-content" contenteditable="true">{{ edit_mode ? product.description|raw : '' }}</div>
                                            <!-- Hidden textarea to store HTML value -->
                                            <textarea id="editorHiddenContent" name="description" class="d-none">{{ edit_mode ? product.description|raw : '' }}</textarea>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Short Description</label>
                                            <textarea class="form-control" id="generatedShortDescription" rows="2">{{ edit_mode ? product.shortDescription : '' }}</textarea>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Meta Title</label>
                                            <input type="text" class="form-control" id="generatedMetaTitle" value="{{ edit_mode ? product.metaTitle : '' }}">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Target Keyphrase</label>
                                            <input type="text" class="form-control" id="generatedTargetKeyphrase" value="{{ edit_mode ? product.targetKeyphrase : '' }}">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Meta Description</label>
                                            <textarea class="form-control" id="generatedMetaDescription" rows="2">{{ edit_mode ? product.metaDescription : '' }}</textarea>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Image Alt Text</label>
                                            <input type="text" class="form-control" id="generatedImageAltText" value="{{ edit_mode ? product.imageAltText : '' }}">
                                        </div>
                                        
                                        {% if is_granted('ROLE_PREMIUM') %}
                                        <div class="mb-3 premium-feature">
                                            <label class="form-label">
                                                <i class="fas fa-crown text-primary"></i> SEO Keywords
                                            </label>
                                            <textarea class="form-control" id="generatedSeoKeywords" rows="4"></textarea>
                                        </div>

                                        <div class="mb-3 premium-feature">
                                            <label class="form-label">
                                                <i class="fas fa-crown text-primary"></i> Social Media Post
                                            </label>
                                            <textarea class="form-control" id="generatedSocialMediaPost" rows="3"></textarea>
                                        </div>
                                        {% endif %}

                                        <div class="d-grid gap-2">
                                            <div class="row">
                                                <div class="col">
                                                    <button type="button" id="previewContent" class="btn btn-outline-primary btn-block w-100">
                                                        <i class="fas fa-eye"></i> Preview
                                                    </button>
                                                </div>
                                                <div class="col">
                                                    <button type="button" id="applyContent" class="btn btn-success btn-block w-100">
                                                        <i class="fas fa-check"></i> {% if edit_mode %}Save Changes{% else %}Apply Generated Content{% endif %}
                                                    </button>
                                                </div>
                                            </div>
                                            {% if not edit_mode %}
                                            <button type="button" id="regenerateContent" class="btn btn-outline-primary">
                                                <i class="fas fa-redo"></i> Generate Again
                                            </button>
                                            {% endif %}
                                            
                                            <!-- Export to store button -->
                                            <div class="mt-4 border-top pt-4">
                                                <div class="alert alert-danger">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                                                        <div>
                                                            <h6 class="fw-bold mb-1">Warning: Direct Export to Your Store</h6>
                                                            <p class="mb-0">This will immediately replace your product content in your WooCommerce store. This action cannot be undone!</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button type="button" id="exportToStore" class="btn btn-danger w-100">
                                                    <i class="fas fa-cloud-upload-alt"></i> Export to Your Store
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="initialState" class="{{ edit_mode ? 'd-none' : '' }}">
                                        <div class="text-center py-4">
                                            <div class="mb-4">
                                                <i class="fas fa-magic fa-4x text-primary"></i>
                                            </div>
                                            <h4>Ready to Generate</h4>
                                            <p class="text-muted mb-4">
                                                Click the button below to generate SEO-optimized content for your product.
                                            </p>
                                            <button type="button" id="generateContent" class="btn btn-primary btn-lg">
                                                <i class="fas fa-magic"></i> Generate Content
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">Product Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- WooCommerce-like product preview -->
                    <div class="preview-container p-4">
                        <div class="row">
                            <!-- Product Image Column -->
                            <div class="col-md-5 mb-4">
                                <div class="preview-image-container border rounded">
                                    <img id="previewImage" src="{{ product.imageUrl ? product.imageUrl : 'https://via.placeholder.com/600x600' }}" class="img-fluid" alt="Product Image">
                                </div>
                            </div>
                            
                            <!-- Product Info Column -->
                            <div class="col-md-7">
                                <h1 id="previewTitle" class="fs-2 fw-bold mb-3">{{ product.name }}</h1>
                                
                                <div class="mb-3">
                                    <span class="badge bg-success">In Stock</span>
                                </div>
                                
                                <div class="fs-4 fw-bold mb-3">
                                    $99.99
                                </div>
                                
                                <div id="previewShortDescription" class="mb-4">
                                    <!-- Short description will be inserted here -->
                                </div>
                                
                                <div class="d-grid gap-2 d-md-block mb-4">
                                    <button class="btn btn-primary" disabled>Add to Cart</button>
                                    <button class="btn btn-outline-secondary" disabled>Add to Wishlist</button>
                                </div>
                                
                                <div class="mb-3">
                                    <strong>Categories:</strong> <span id="previewCategories">Sample Category</span>
                                </div>
                                
                                <div>
                                    <strong>SKU:</strong> <span>WC-{{ product.woocommerceId }}</span>
                                </div>
                            </div>
                            
                            <!-- Product Tabs -->
                            <div class="col-12 mt-4">
                                <ul class="nav nav-tabs" id="productTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true">Description</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="additional-info-tab" data-bs-toggle="tab" data-bs-target="#additional-info" type="button" role="tab" aria-controls="additional-info" aria-selected="false">Additional Information</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">Reviews (0)</button>
                                    </li>
                                </ul>
                                <div class="tab-content p-4 border border-top-0 rounded-bottom" id="productTabsContent">
                                    <div class="tab-pane fade show active" id="description" role="tabpanel" aria-labelledby="description-tab">
                                        <div id="previewDescription">
                                            <!-- Description will be inserted here -->
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="additional-info" role="tabpanel" aria-labelledby="additional-info-tab">
                                        <table class="table">
                                            <tbody>
                                                <tr>
                                                    <th scope="row" style="width: 30%;">Weight</th>
                                                    <td>N/A</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Dimensions</th>
                                                    <td>N/A</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Meta Title</th>
                                                    <td id="previewMetaTitle"></td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Target Keyphrase</th>
                                                    <td id="previewTargetKeyphrase"></td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Meta Description</th>
                                                    <td id="previewMetaDescription"></td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">Image Alt Text</th>
                                                    <td id="previewImageAlt"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                                        <p>There are no reviews yet.</p>
                                        <p>This is a preview - reviews would be displayed here.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Basic vs Premium AI Services</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100 border-info">
                                <div class="card-header bg-info bg-opacity-10">
                                    <h5 class="card-title mb-0"><i class="fas fa-robot me-2"></i> Basic AI Service</h5>
                                </div>
                                <div class="card-body">
                                    <h6 class="mb-3">Features:</h6>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-check text-success me-2"></i> Target Keyphrase Generation
                                        </li>
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-check text-success me-2"></i> Meta Title Creation
                                        </li>
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-check text-success me-2"></i> Product Descriptions
                                        </li>
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-check text-success me-2"></i> Short Descriptions
                                        </li>
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-check text-success me-2"></i> Meta Descriptions
                                        </li>
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-check text-success me-2"></i> Image Alt Text
                                        </li>
                                    </ul>
                                    <p class="card-text">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        Uses GPT-3.5 Turbo model (0.5 credits per generation)
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-primary">
                                <div class="card-header bg-primary bg-opacity-10">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-crown text-primary me-2"></i> Premium AI Service
                                        {% if is_granted('ROLE_PREMIUM') %}
                                            <span class="badge bg-success ms-2">Available</span>
                                        {% else %}
                                            <span class="badge bg-secondary ms-2">Upgrade Required</span>
                                        {% endif %}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <h6 class="mb-3">All Basic Features Plus:</h6>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-star text-warning me-2"></i> Enhanced Prompts
                                            <span class="ms-auto badge bg-primary">Premium</span>
                                        </li>
                                        <li class="list-group-item">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-star text-warning me-2"></i> SEO Keywords Extraction
                                                <span class="ms-auto badge bg-primary">Premium</span>
                                            </div>
                                            <div class="text-muted small mt-1">
                                                Generates a comprehensive list of 15-20 SEO keywords with search intent grouping, helping you target the right audience and improve search rankings.
                                            </div>
                                        </li>
                                        <li class="list-group-item">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-star text-warning me-2"></i> Social Media Post Creation
                                                <span class="ms-auto badge bg-primary">Premium</span>
                                            </div>
                                            <div class="text-muted small mt-1">
                                                Creates platform-optimized social media posts to promote your products with engaging content, hashtags, and calls-to-action.
                                            </div>
                                        </li>
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-star text-warning me-2"></i> Custom Tone Selection
                                            <span class="ms-auto badge bg-primary">Premium</span>
                                        </li>
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-star text-warning me-2"></i> Competitor URL Analysis
                                            <span class="ms-auto badge bg-primary">Premium</span>
                                        </li>
                                        <li class="list-group-item d-flex align-items-center">
                                            <i class="fas fa-star text-warning me-2"></i> Target Keywords Integration
                                            <span class="ms-auto badge bg-primary">Premium</span>
                                        </li>
                                    </ul>
                                    <p class="card-text">
                                        <i class="fas fa-bolt text-warning me-2"></i>
                                        Uses GPT-4 Turbo model (1 credit per generation)
                                    </p>
                                    {% if not is_granted('ROLE_PREMIUM') %}
                                        <div class="d-grid gap-2">
                                            <a href="{{ path('app_subscription_plans') }}" class="btn btn-primary">
                                                <i class="fas fa-crown me-2"></i> Upgrade to Premium
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Custom Editor Implementation
    const editorButtons = document.querySelectorAll('.editor-toolbar .btn');
    const editorContent = document.getElementById('editor-content');
    const hiddenTextarea = document.getElementById('editorHiddenContent');
    const generateBtn = document.getElementById('generateContent');
    const regenerateBtn = document.getElementById('regenerateContent');
    const applyBtn = document.getElementById('applyContent');
    const exportBtn = document.getElementById('exportToStore');
    const initialState = document.getElementById('initialState');
    const generationProgress = document.getElementById('generationProgress');
    const generatedContent = document.getElementById('generatedContent');
    const generationStatus = document.getElementById('generationStatus');
    const isEditMode = {{ edit_mode ? 'true' : 'false' }};
    const previewBtn = document.getElementById('previewContent');
    // Initialize the editor with content if in edit mode
    if (isEditMode) {
        updateHiddenContent();
    }
    
    // Preview functionality
    if (previewBtn) {
        previewBtn.addEventListener('click', showPreview);
    }
    
    // Export to store functionality
    if (exportBtn) {
        exportBtn.addEventListener('click', exportToStore);
    }
    
    function exportToStore() {
        // Show confirmation dialog
        if (confirm('WARNING: This will immediately export and replace the product content in your WooCommerce store. This action cannot be undone!\n\nAre you absolutely sure you want to continue?')) {
            try {
                // Get HTML content from the editor
                let descriptionHtml = '';
                
                if (hiddenTextarea && hiddenTextarea.value) {
                    // Sanitize HTML content to prevent JSON issues
                    descriptionHtml = hiddenTextarea.value;
                    
                    // Remove HTML comments which can break JSON
                    descriptionHtml = descriptionHtml.replace(/<!--[\s\S]*?-->/g, '');
                    
                    // Ensure HTML is valid and well-formed
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(descriptionHtml, 'text/html');
                    descriptionHtml = doc.body.innerHTML;
                }
                
                const content = {
                    description: descriptionHtml,
                    shortDescription: document.getElementById('generatedShortDescription').value || '',
                    metaTitle: document.getElementById('generatedMetaTitle').value || '',
                    targetKeyphrase: document.getElementById('generatedTargetKeyphrase').value || '',
                    metaDescription: document.getElementById('generatedMetaDescription').value || '',
                    imageAltText: document.getElementById('generatedImageAltText').value || '',
                    directExport: true // Flag to indicate this should be exported directly
                };
    
                {% if is_granted('ROLE_PREMIUM') %}
                // Add premium content if available
                if (document.getElementById('generatedSeoKeywords')) {
                    content.seoKeywords = document.getElementById('generatedSeoKeywords').value || '';
                }
                
                if (document.getElementById('generatedSocialMediaPost')) {
                    content.socialMediaPost = document.getElementById('generatedSocialMediaPost').value || '';
                }
                {% endif %}
    
                // Disable the export button and show loading state
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Exporting...';
    
                // Make the API request to export directly to WooCommerce
                fetch('{{ path('app_woocommerce_export', {'id': product.id}) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(content)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Server response: ${response.status} - ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert('Successfully exported to your WooCommerce store!');
                        window.location.href = '{{ path('app_woocommerce_dashboard') }}';
                    } else {
                        throw new Error(data.message || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Export error:', error);
                    alert('Error exporting to store: ' + error.message);
                    // Reset button state
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Export to Your Store';
                });
            } catch (error) {
                console.error('Client error:', error);
                alert('Error preparing content for export: ' + error.message);
            }
        }
    }
    
    function showPreview() {
        // Make sure content is updated
        updateHiddenContent();
        
        // Get current content values
        const description = hiddenTextarea.value;
        const shortDescription = document.getElementById('generatedShortDescription').value;
        const metaTitle = document.getElementById('generatedMetaTitle').value;
        const targetKeyphrase = document.getElementById('generatedTargetKeyphrase').value;
        const metaDescription = document.getElementById('generatedMetaDescription').value;
        const imageAltText = document.getElementById('generatedImageAltText').value;
        
        // Update preview modal with current content
        document.getElementById('previewDescription').innerHTML = description;
        document.getElementById('previewShortDescription').innerHTML = shortDescription;
        document.getElementById('previewMetaTitle').textContent = metaTitle;
        document.getElementById('previewTargetKeyphrase').textContent = targetKeyphrase;
        document.getElementById('previewMetaDescription').textContent = metaDescription;
        document.getElementById('previewImageAlt').textContent = imageAltText;
        
        // Set image alt attribute if available
        if (imageAltText) {
            document.getElementById('previewImage').setAttribute('alt', imageAltText);
        }
        
        // Show the modal
        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        previewModal.show();
    }

    // Set up toolbar buttons
    editorButtons.forEach(button => {
        button.addEventListener('click', function() {
            const command = this.dataset.command;
            const value = this.dataset.value || null;
            
            if (command === 'createLink') {
                const url = prompt('Enter the link URL');
                if (url) {
                    document.execCommand(command, false, url);
                }
            } else {
                document.execCommand(command, false, value);
            }
            
            editorContent.focus();
            updateHiddenContent();
        });
    });

    // Update hidden textarea with HTML content
    function updateHiddenContent() {
        if (hiddenTextarea && editorContent) {
            hiddenTextarea.value = editorContent.innerHTML;
        }
    }

    // Sync editable div with hidden textarea on input
    if (editorContent) {
        editorContent.addEventListener('input', updateHiddenContent);
        editorContent.addEventListener('blur', updateHiddenContent);
    }
    const progressBar = document.getElementById('progressBar');
    const generationStepDetail = document.getElementById('generationStepDetail');
    let progressInterval;
    
    function updateProgressBar(value) {
        progressBar.style.width = value + '%';
        progressBar.setAttribute('aria-valuenow', value);
        progressBar.textContent = value + '%';
    }
    
    function showProgress() {
        initialState.classList.add('d-none');
        generationProgress.classList.remove('d-none');
        generatedContent.classList.add('d-none');
        
        // Reset progress bar
        updateProgressBar(0);
        
        // Get processing mode (standard or premium)
        const isPremium = document.querySelector('input[name="processingMode"]:checked')?.value === 'premium';
        const usePremiumFeatures = document.getElementById('usePremiumFeatures') ? 
            document.getElementById('usePremiumFeatures').checked : false;
        
        // Set max time based on processing mode
        const maxTime = isPremium ? 40000 : 20000; // 40 seconds for premium, 20 for standard
        
        // Define the steps for progress simulation
        const steps = [
            { percent: 10, message: "Initializing AI model..." },
            { percent: 20, message: "Analyzing product data..." },
            { percent: 30, message: "Generating target keyphrases..." },
            { percent: 40, message: "Creating meta title..." },
            { percent: 50, message: "Writing product description..." },
            { percent: 60, message: "Generating short description..." },
            { percent: 70, message: "Creating meta description..." },
            { percent: 80, message: "Generating image alt text..." }
        ];
        
        // Add premium-specific steps if applicable
        if (isPremium && usePremiumFeatures) {
            steps.push(
                { percent: 85, message: "Extracting SEO keywords..." },
                { percent: 90, message: "Creating social media content..." },
                { percent: 95, message: "Optimizing for premium quality..." }
            );
        }
        
        // Calculate time per step
        const timePerStep = maxTime / steps.length;
        let currentStep = 0;
        
        // Clear any existing interval
        if (progressInterval) clearInterval(progressInterval);
        
        // Start progress simulation
        progressInterval = setInterval(() => {
            if (currentStep < steps.length) {
                const step = steps[currentStep];
                updateProgressBar(step.percent);
                generationStepDetail.textContent = step.message;
                currentStep++;
            } else {
                // If we've gone through all steps but haven't received a response yet,
                // keep progress bar moving slowly to 99%
                const currentValue = parseInt(progressBar.getAttribute('aria-valuenow'));
                if (currentValue < 99) {
                    updateProgressBar(Math.min(currentValue + 1, 99));
                    generationStepDetail.textContent = "Finalizing and optimizing content...";
                }
            }
        }, timePerStep / 2); // Divide by 2 to make steps more granular
    }

    function showContent(content) {
        // Clear the progress interval
        if (progressInterval) clearInterval(progressInterval);
        
        // Complete the progress bar
        updateProgressBar(100);
        generationStepDetail.textContent = "Content generation complete!";
        
        // Short delay to show 100% completion before showing content
        setTimeout(() => {
            // Update the editor content
            editorContent.innerHTML = content.description || '';
            updateHiddenContent(); // Update hidden textarea
            document.getElementById('generatedShortDescription').value = content.shortDescription || '';
            document.getElementById('generatedMetaTitle').value = content.metaTitle || '';
            document.getElementById('generatedTargetKeyphrase').value = content.targetKeyphrase || '';
            document.getElementById('generatedMetaDescription').value = content.metaDescription || '';
            document.getElementById('generatedImageAltText').value = content.imageAltText || '';
            
            {% if is_granted('ROLE_PREMIUM') %}
            // Set premium-only content if available
            if (document.getElementById('generatedSeoKeywords')) {
                document.getElementById('generatedSeoKeywords').value = content.seoKeywords || '';
            }
            
            if (document.getElementById('generatedSocialMediaPost')) {
                document.getElementById('generatedSocialMediaPost').value = content.socialMediaPost || '';
            }
            {% endif %}

            generationProgress.classList.add('d-none');
            generatedContent.classList.remove('d-none');
        }, 500);
    }

    function generateContent() {
        showProgress();

        // Get options for request
        let requestData = {
            processingMode: document.querySelector('input[name="processingMode"]:checked').value
        };
        
        {% if is_granted('ROLE_PREMIUM') %}
        if (document.getElementById('usePremiumFeatures').checked) {
            requestData.usePremiumFeatures = true;
            requestData.targetKeywords = document.getElementById('targetKeywords').value;
            requestData.competitorUrls = document.getElementById('competitorUrls').value;
            requestData.tone = document.getElementById('contentTone').value;
            requestData.platform = 'Instagram'; // Default platform for social media content
        }
        {% endif %}

        fetch('{{ path('app_woocommerce_process_ai_content', {'id': product.id}) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showContent(data.content);
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            alert('Error generating content: ' + error.message);
            initialState.classList.remove('d-none');
            generationProgress.classList.add('d-none');
        });
    }

    function applyContent() {
        try {
            // Get HTML content from the editor
            let descriptionHtml = '';
            
            if (hiddenTextarea && hiddenTextarea.value) {
                // Sanitize HTML content to prevent JSON issues
                descriptionHtml = hiddenTextarea.value;
                
                // Remove HTML comments which can break JSON
                descriptionHtml = descriptionHtml.replace(/<!--[\s\S]*?-->/g, '');
                
                // Ensure HTML is valid and well-formed
                const parser = new DOMParser();
                const doc = parser.parseFromString(descriptionHtml, 'text/html');
                descriptionHtml = doc.body.innerHTML;
            }
            
            const content = {
                description: descriptionHtml,
                shortDescription: document.getElementById('generatedShortDescription').value || '',
                metaTitle: document.getElementById('generatedMetaTitle').value || '',
                targetKeyphrase: document.getElementById('generatedTargetKeyphrase').value || '',
                metaDescription: document.getElementById('generatedMetaDescription').value || '',
                imageAltText: document.getElementById('generatedImageAltText').value || ''
            };

            {% if is_granted('ROLE_PREMIUM') %}
            // Add premium content if available
            if (document.getElementById('generatedSeoKeywords')) {
                content.seoKeywords = document.getElementById('generatedSeoKeywords').value || '';
            }
            
            if (document.getElementById('generatedSocialMediaPost')) {
                content.socialMediaPost = document.getElementById('generatedSocialMediaPost').value || '';
            }
            {% endif %}

            // Make the API request
            fetch('{{ path('app_woocommerce_apply_ai_content', {'id': product.id}) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(content)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Server response: ${response.status} - ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    window.location.href = '{{ path('app_woocommerce_dashboard') }}';
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                alert('Error saving content: ' + error.message);
            });
        } catch (error) {
            console.error('Client error:', error);
            alert('Error preparing content: ' + error.message);
        }
    }

    // Add event listeners
    if (generateBtn) {
        generateBtn.addEventListener('click', generateContent);
    }
    
    if (regenerateBtn) {
        regenerateBtn.addEventListener('click', generateContent);
    }
    
    applyBtn.addEventListener('click', applyContent);
});
</script>
{% endblock %}